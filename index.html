<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Planary</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: "#0f172a",
            soft: "#f8fafc",
            card: "rgba(255,255,255,0.92)",
            baby: "#9ec5ff",
            baby2: "#cfe3ff",
            bluegray: "#5b6b84",
            lavender: "#d8d0ff"
          },
          boxShadow: {
            soft: "0 10px 30px rgba(15, 23, 42, 0.08)",
            insetSoft: "inset 0 1px 0 rgba(255,255,255,.55)"
          }
        }
      }
    }
  </script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- SortableJS (drag reorder with delay) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <!-- å­—é«”ï¼šå…ˆç”¨ Noto Sans TCï¼ˆä½ è¦æºæ³‰åœ“é«”æˆ‘ä¸‹é¢æœ‰ä¿ç•™ GenSenRoundedTW çš„ font-family åç¨±ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* æ›´è—ç°ã€å°‘ç™½ä¸€é» */
      --bg1:#eef3fb;
      --bg2:#dee8f8;
      --line: rgba(91,107,132,.22);
      --ring: rgba(158,197,255,.45);
    }
    html,body{ height:100%; }
    body{
  font-family: "GenSenRoundedTW", "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(520px 320px at 12% 0%, rgba(158,197,255,.55), transparent 60%),
    radial-gradient(620px 420px at 88% 8%, rgba(216,208,255,.45), transparent 60%),
    radial-gradient(460px 360px at 50% 90%, rgba(207,227,255,.35), transparent 65%),
    linear-gradient(180deg, #eef3fb 0%, #f7faff 100%);
  color:#0f172a;
}
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 84px); }
    .glass { background: rgba(225,235,250,0.78); backdrop-filter: blur(10px); }
    .chip { border: 1px solid var(--line); background: rgba(255,255,255,.72); }
    .btn { border: 1px solid var(--line); }
    .btnPrimary { background: linear-gradient(180deg, rgba(158,197,255,.95), rgba(158,197,255,.65)); }
    .btnPrimary:hover{ filter: brightness(0.98); }
    .input {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.82);
      outline: none;
    }
    .input:focus{ box-shadow: 0 0 0 4px var(--ring); }
    .segActive{
      background: linear-gradient(180deg, rgba(207,227,255,.95), rgba(207,227,255,.65));
      border-color: rgba(158,197,255,.55);
    }
    .hint { color: rgba(91,107,132,.9); }
    .mono { font-variant-numeric: tabular-nums; }
/* ====== polish pack ====== */

/* æŒ‰éˆ•æŒ‰ä¸‹çš„å›é¥‹ï¼ˆçˆ½æ„Ÿï¼‰ */
.tap {
  transition: transform .12s ease, filter .12s ease;
}
.tap:active { transform: translateY(1px) scale(.98); filter: brightness(.98); }

/* Hero å¡ï¼šæ›´åƒä¸»è¦–è¦º */
.heroCard{
  position: relative;
  overflow: hidden;
}
.heroCard::before{
  content:"";
  position:absolute; inset:-40px;
  background:
    radial-gradient(380px 220px at 20% 0%, rgba(158,197,255,.55), transparent 60%),
    radial-gradient(420px 260px at 90% 20%, rgba(216,208,255,.40), transparent 60%);
  pointer-events:none;
}
.heroCard::after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.15));
  pointer-events:none;
}
.heroInner{ position: relative; }

/* Hero æ•¸å­—æ›´ç«‹é«” */
.heroNum{
  text-shadow: 0 10px 22px rgba(15,23,42,.14);
}

/* æ—¥æœŸ pillï¼šæœªé¸æ›´æ·¡ã€é¸ä¸­æ›´å‡¸é¡¯ */
.dayPill{
  border: 1px solid var(--line);
  background: rgba(255,255,255,.60);
}
.dayPill:hover{ background: rgba(255,255,255,.78); }
.dayPillActive{
  border-color: rgba(158,197,255,.75) !important;
  background: linear-gradient(180deg, rgba(207,227,255,.95), rgba(207,227,255,.60));
  box-shadow: 0 10px 22px rgba(15,23,42,.10);
}
.dayPillActive .hint{ color: rgba(15,23,42,.65); }

/* æ©«æ»‘è¦–è¦ºæ›´é †ï¼ˆâœ… ä¿ç•™æ»‘æ¡¿ç‰ˆæœ¬ï¼‰ */
.scrollX{
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;

  /* Firefox */
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,.3) transparent;
}

/* Chrome / Edge / Safari */
.scrollX::-webkit-scrollbar{
  height: 6px;                 /* ğŸ‘ˆ æ»‘æ¡¿é«˜åº¦ï¼Œå¯æ”¹ 4~8 */
}
.scrollX::-webkit-scrollbar-track{
  background: transparent;     /* è»Œé“é€æ˜ */
}
.scrollX::-webkit-scrollbar-thumb{
  background-color: rgba(0,0,0,.3); /* æ»‘å¡Šé¡è‰² */
  border-radius: 999px;        /* åœ“è§’ */
}
.scrollX::-webkit-scrollbar-thumb:hover{
  background-color: rgba(0,0,0,.45);
}

/* åº•éƒ¨ Nav æ›´æµ®ä¸€é» */
.bottomFloat{
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(15,23,42,.12);
}

/* è¡Œç¨‹å¡ç‰‡ï¼šå³å´æ“ä½œæ›´åƒå·¥å…·åˆ— */
.actionBtn{
  width: 40px; height: 40px;
  border-radius: 18px;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background-image:
    repeating-linear-gradient(
      45deg,
      rgba(0,0,0,.015) 0px,
      rgba(0,0,0,.015) 1px,
      transparent 1px,
      transparent 3px
    );
  opacity:.35;
  z-index:0;
}
#app{ position:relative; z-index:1; }
:root{
  --bg-photo: none;              /* èƒŒæ™¯åœ–ï¼ˆurl(...) æˆ– noneï¼‰ */
  --bg-photo-opacity: .22;       /* èƒŒæ™¯åœ–æ¿ƒæ·¡ 0~0.5 å»ºè­° */
  --bg-photo-blur: 2px;          /* èƒŒæ™¯æ¨¡ç³Šï¼Œè®“å¡ç‰‡æ›´æ¸…æ¥š */
}

/* èƒŒæ™¯åœ–å±¤ï¼šç–Šåœ¨ä½ åŸæœ¬æ¼¸å±¤èƒŒæ™¯ä¸Š */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  background-image: var(--bg-photo);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: var(--bg-photo-opacity);
  filter: saturate(.8) blur(var(--bg-photo-blur));
}

/* ç¢ºä¿ä½ çš„ App å…§å®¹åœ¨èƒŒæ™¯åœ–ä¹‹ä¸Š */
#app{
  position: relative;
  z-index: 1;
}
  </style>
</head>

<body>
<div id="app" class="min-h-screen">
  <!-- Top -->
  <header class="sticky top-0 z-40">
    <div class="glass border-b" style="border-color: var(--line);">
      <div class="max-w-[460px] mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl shadow-soft overflow-hidden bg-white border" style="border-color: var(--line);">
            <img v-if="activeTrip?.avatar" :src="activeTrip.avatar" class="w-full h-full object-cover" alt="">
            <div v-else class="w-full h-full grid place-items-center text-bluegray">ğŸ§³</div>
          </div>
          <div>
            <div class="text-[13px] hint">{{ nowText }}</div>
            <div class="font-bold tracking-tight text-[15px]">
              {{ activeTrip ? activeTrip.title : "æˆ‘çš„è¡Œç¨‹ç›®éŒ„" }}
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- âœ… ç›´æ¥å›ç›®éŒ„ï¼ˆä¸ç”¨é€²è¨­å®šï¼‰ -->
          <button v-if="activeTrip"
                  class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="backToCatalog()">
            ğŸ  å›ç›®éŒ„
          </button>
          <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="openTripCatalog=true">
            ğŸ“š ç›®éŒ„
          </button>
          <button v-if="activeTrip" class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="openTripSettings=true">
            âš™ï¸ è¨­å®š
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-[460px] mx-auto px-4 pt-4 safe-bottom">
    <!-- If no trip selected -> catalog -->
    <section v-if="!activeTrip">
      <div class="rounded-3xl p-4 bg-card shadow-soft border" style="border-color: var(--line);">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-[16px]">ğŸ“Œ é¸æ“‡è¡Œç¨‹</div>
            <div class="text-[13px] hint mt-1">é»å¡ç‰‡å°±ç›´æ¥é€²å…¥ï¼ˆä¸ç”¨å¦å¤–é–‹å•Ÿï¼‰</div>
          </div>
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                  @click="startCreateTrip()">
            â• æ–°å¢è¡Œç¨‹
          </button>
        </div>

        <div class="mt-4 grid gap-3">
          <button v-for="t in store.trips" :key="t.id"
                  class="text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                  style="border-color: var(--line);"
                  @click="selectTrip(t.id)">
            <div class="flex gap-3 items-center">
              <div class="w-12 h-12 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="t.avatar" :src="t.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-bold truncate">{{ t.title }}</div>
                <div class="text-[13px] hint mt-0.5">
                  ğŸ“… {{ t.startDate }} â†’ {{ t.endDate }} Â· ğŸ‘¥ {{ t.people.length }} äºº Â· ğŸ’± {{ t.currencies.length }} å¹£åˆ¥
                </div>
              </div>
              <div class="text-[20px]">â€º</div>
            </div>
          </button>

          <div v-if="store.trips.length===0" class="text-center py-10 hint">
            é‚„æ²’æœ‰è¡Œç¨‹ï½å…ˆæ–°å¢ä¸€å€‹å§ âœ¨
          </div>
        </div>
      </div>
    </section>

    <!-- Trip Home (Tabs) -->
    <section v-else>
      <!-- Countdown -->
     <div class="rounded-3xl p-4 bg-card shadow-soft border heroCard" style="border-color: var(--line);">
  <div class="heroInner">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-bold text-[16px]">â³ é›¢å‡ºç™¼é‚„æœ‰</div>
            <div class="mt-1 text-[38px] font-extrabold tracking-tight mono heroNum">
              {{ daysUntil(activeTrip.startDate) }} å¤©
            </div>
            <div class="text-[13px] hint">ï¼ˆä»¥ {{ activeTrip.startDate }} ç‚ºå‡ºç™¼æ—¥ï¼‰</div>
          </div>
          <div class="text-right">
            <div class="text-[13px] hint">ğŸ“ é è¨­åŸå¸‚</div>
            <div class="font-semibold">{{ activeTrip.city || "Seoul" }}</div>
            <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white mt-2"
                    @click="tab='weather'">
              â˜ï¸ çœ‹å¤©æ°£
            </button>
          </div>
        </div>

        <!-- âœ… èˆªç­ï¼šä¸€é€²è¡Œç¨‹å°±çœ‹åˆ°ï¼ˆå¯ç”¨æ–¼å…¶ä»–æ—…è¡Œï¼‰ -->
        <div class="mt-4" v-if="(activeTrip.flights||[]).length">
          <div class="flex items-center justify-between">
            <div class="font-bold text-[16px]">âœˆï¸ èˆªç­</div>
            <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                    @click="openTripSettings=true">
              âš™ï¸ ç®¡ç†
            </button>
          </div>
          <div class="mt-2 grid gap-2">
            <div v-for="f in activeTrip.flights" :key="f.id"
                 class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                 style="border-color: var(--line);">
              <div class="text-[12px] hint">{{ f.type || "èˆªç­" }} Â· {{ f.date || "" }}</div>
              <div class="mt-1 font-bold">{{ f.depAirport || "â€”" }} â†’ {{ f.arrAirport || "â€”" }}</div>
              <div class="mt-1 text-[13px] hint mono">{{ f.depTime || "â€”" }} â†’ {{ f.arrTime || "â€”" }}</div>
              <div class="mt-1 text-[13px] hint" v-if="f.flightNo">èˆªç­ï¼š{{ f.flightNo }}</div>
              <div class="mt-1 text-[13px]" v-if="f.note">ğŸ“ {{ f.note }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-4 rounded-3xl p-2 bg-white/65 border shadow-soft sticky top-[72px] z-30"
           style="border-color: var(--line);">
        <div class="grid grid-cols-5 gap-2 text-[12px]">
          <button @click="tab='plan'" :class="segClass('plan')" class="rounded-2xl py-2 px-2 btn">
            ğŸ—“ï¸ è¡Œç¨‹
          </button>
          <button @click="tab='money'" :class="segClass('money')" class="rounded-2xl py-2 px-2 btn">
            ğŸ’¸ è¨˜å¸³
          </button>
          <button @click="tab='luggage'" :class="segClass('luggage')" class="rounded-2xl py-2 px-2 btn">
            ğŸ’ è¡Œæ
          </button>
          <button @click="tab='fav'" :class="segClass('fav')" class="rounded-2xl py-2 px-2 btn">
            â­ æ”¶è—
          </button>
          <button @click="tab='info'" :class="segClass('info')" class="rounded-2xl py-2 px-2 btn">
            ğŸ“Œ è³‡è¨Š
          </button>
        </div>
      </div>

      <!-- Panels -->
      <div class="mt-4">
        <!-- è¡Œç¨‹ -->
        <section v-show="tab==='plan'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <!-- Day scroller -->
<div class="p-4 border-b" style="border-color: var(--line);">
  <div class="flex items-center justify-between">
    <div class="font-bold text-[16px]">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹</div>
    <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
            @click="openAddPlanItem()">
      â• æ–°å¢
    </button>
  </div>

  <!-- âœ… æ—¥æœŸæ©«æ»‘åˆ—ï¼ˆåšæˆè·Ÿæ”¶è—ä¸€æ¨£çš„çµæ§‹ï¼‰ -->
<div
  class="mt-3 flex gap-2 pb-2 scrollX"
  :class="(tripDays(activeTrip).length + 1) >= 7
    ? 'flex-nowrap overflow-x-auto'
    : 'flex-wrap overflow-x-hidden'"
>
  <!-- å¾…æ”¾ -->
  <button
    @click="switchDay('_unscheduled')"
    class="dayPill tap shadow-insetSoft rounded-2xl px-3 py-2 text-[13px]"
    :class="[
      activeDay==='_unscheduled' ? 'dayPillActive' : '',
      (tripDays(activeTrip).length + 1) >= 7 ? 'shrink-0 w-[92px]' : 'flex-1'
    ]"
    style="border-color: var(--line);"
  >
    <div class="font-semibold">ğŸ—‚ï¸ å¾…æ”¾</div>
    <div class="text-[11px] hint">
      {{ (activeTrip.itinerary._unscheduled||[]).length }} ç­†
    </div>
  </button>

  <!-- æ—¥æœŸ -->
  <button
    v-for="d in tripDays(activeTrip)"
    :key="activeTrip.id+'-'+d"
    @click="switchDay(d)"
    class="dayPill tap shadow-insetSoft rounded-2xl px-3 py-2 text-[13px]"
    :class="[
      activeDay===d ? 'dayPillActive' : '',
      (tripDays(activeTrip).length + 1) >= 7 ? 'shrink-0 w-[74px]' : 'flex-1'
    ]"
    style="border-color: var(--line);"
  >
    <div class="font-semibold">{{ md(d) }}</div>
    <div class="text-[11px] hint">{{ dow(d) }}</div>
  </button>
</div>
  </div>
</div>

              <!-- list -->
<div class="p-4">
  <div class="text-[13px] hint">ğŸ‘† é•·æŒ‰ 0.2 ç§’å³å¯æ‹–æ›³æ’åºï¼ˆæ»‘å‹•è§€çœ‹æ²’å•é¡Œï¼‰</div>

  <div class="mt-3" v-if="(activeTrip.itinerary[activeDay]||[]).length===0">
    <div class="rounded-2xl p-4 border bg-white/65 text-center hint" style="border-color: var(--line);">
      {{ activeDay==='_unscheduled' ? 'å¾…æ”¾å€ç›®å‰æ˜¯ç©ºçš„ï½å¯ä»¥æŠŠé‚„æ²’æ±ºå®šæ—¥æœŸçš„å…ˆä¸Ÿé€™è£¡ âœ¨' : 'é€™å¤©é‚„æ²’å®‰æ’ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨' }}
    </div>
  </div>

  <div class="mt-3 space-y-3" :id="'planList-'+activeDay">
    <div v-for="item in (activeTrip.itinerary[activeDay]||[])" :key="item.id"
         class="rounded-3xl p-4 bg-white/70 border shadow-soft"
         style="border-color: var(--line);">

      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <!-- âœ… è‹¥åœ¨å¾…æ”¾å€ï¼šé¡¯ç¤ºæŒ‡æ´¾æ—¥æœŸï¼ˆä½†ä»ä¿ç•™ç·¨è¼¯/åˆªé™¤ï¼‰ -->
          <div class="mb-2" v-if="activeDay==='_unscheduled'">
            <select class="input rounded-xl px-2 py-1 text-[12px]"
                    @change="assignPlanDate(item, $event.target.value)">
              <option value="">æŒ‡æ´¾æ—¥æœŸâ€¦</option>
              <option v-for="d in tripDays(activeTrip)" :key="d" :value="d">
                {{ md(d) }} {{ dow(d) }}
              </option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <div class="text-[12px] px-2 py-1 rounded-xl chip">
              {{ item.time || "ï¼ˆæœªå¡«æ™‚é–“ï¼‰" }}
            </div>
            <div class="text-[12px] px-2 py-1 rounded-xl chip">
              {{ item.category || "æœªåˆ†é¡" }}
            </div>
          </div>

          <div class="mt-2 font-bold text-[16px] break-words">
            {{ item.title || "ï¼ˆæœªå¡«æ¨™é¡Œï¼‰" }}
          </div>
          <div class="mt-1 text-[13px] hint break-words" v-if="item.place">ğŸ“ {{ item.place }}</div>
          <div class="mt-2 text-[13px] break-words" v-if="item.note">ğŸ“ {{ item.note }}</div>

          <div class="mt-2 flex flex-wrap gap-2" v-if="item.link || item.map">
            <a v-if="item.link" :href="item.link" target="_blank"
               class="text-[12px] underline decoration-baby/60">
              ğŸ”— ç¶²å€
            </a>
            <a v-if="item.map" :href="item.map" target="_blank"
               class="text-[12px] underline decoration-lavender/60">
              ğŸ—ºï¸ åœ°åœ–
            </a>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2" v-if="(item.images||[]).length">
            <img v-for="(img,idx) in item.images" :key="idx" :src="img"
                 class="w-full aspect-square object-cover rounded-2xl border"
                 style="border-color: var(--line);" />
          </div>
        </div>

        <div class="flex flex-col gap-2 shrink-0">
          <button class="btn bg-white/70 hover:bg-white tap actionBtn" @click="editPlanItem(item)">âœï¸</button>
          <button class="btn bg-white/70 hover:bg-white tap actionBtn" @click="removePlanItem(item.id)">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
  </div>
</div>
      
        </section>

        <!-- è¨˜å¸³ -->
        <section v-show="tab==='money'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-bold text-[16px]">ğŸ’¸ è¨˜å¸³</div>
                  <div class="text-[13px] hint mt-1">å¤šå¹£åˆ¥å¯æ–°å¢ï¼›æœ€å¾Œçµ±ä¸€æŠ˜ç®—å°å¹£</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                          @click="openCurrencyManager=true">
                    ğŸ’± åŒ¯ç‡
                  </button>
                  <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                          @click="openAddExpense()">
                    â• æ–°å¢
                  </button>
                </div>
              </div>

              <div class="mt-4 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="text-[13px] hint">ç¸½èŠ±è²»ï¼ˆæŠ˜å°å¹£ï¼‰</div>
                <div class="mt-1 text-[34px] font-extrabold mono">NT$ {{ money(totalExpenseTWD()) }}</div>
                <div class="mt-1 text-[13px] hint">
                  æœ¬æ—¥ï¼šNT$ {{ money(dayTotalTWD(selectedExpenseDay)) }} Â·
                  é¸æ—¥ï¼š{{ selectedExpenseDay || "å…¨éƒ¨" }}
                </div>
              </div>

              <!-- âœ… å€‹äººç´¯ç©ï¼ˆå«é ­åƒï¼‰ -->
              <div class="mt-4 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-[16px]">ğŸ‘¥ å€‹äººç´¯ç©</div>
                  <div class="text-[12px] hint">ä¾åˆ†æ”¤æŠ˜å°å¹£</div>
                </div>
                <div class="mt-3 grid gap-2">
                  <div v-for="p in personTotals()" :key="'pt-'+p.pid"
                       class="flex items-center gap-3 rounded-2xl p-3 border bg-white/70"
                       style="border-color: var(--line);">
                    <div class="w-10 h-10 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                      <img v-if="p.avatar" :src="p.avatar" class="w-full h-full object-cover" alt="">
                      <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold truncate">{{ p.name }}</div>
                      <div class="text-[12px] hint">å·²åˆ†æ”¤ï¼šNT$ {{ money(p.total) }}</div>
                    </div>
                    <div class="font-extrabold mono">NT$ {{ money(p.total) }}</div>
                  </div>
                </div>
              </div>

              <!-- day filter -->
              <div class="mt-3 flex items-center gap-2 overflow-x-auto pb-2">
                <button class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="selectedExpenseDay==='' ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="selectedExpenseDay=''">
                  å…¨éƒ¨
                </button>
                <button v-for="d in tripDays(activeTrip)" :key="'ed-'+d"
                        class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="selectedExpenseDay===d ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="selectedExpenseDay=d">
                  {{ md(d) }}
                </button>
              </div>
            </div>

            <!-- expense list -->
            <div class="p-4">
              <div v-if="filteredExpenses().length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                é‚„æ²’æœ‰è¨˜å¸³ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨
              </div>

              <div class="space-y-3">
                <div v-for="e in filteredExpenses()" :key="e.id"
                     class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                     style="border-color: var(--line);">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-[12px] hint mono">ğŸ“… {{ e.date }} Â· {{ e.category || "æœªåˆ†é¡" }} Â· {{ e.method || "ç¾é‡‘" }}</div>
                      <div class="mt-1 font-bold text-[16px] break-words">{{ e.title || "ï¼ˆæœªå¡«é …ç›®ï¼‰" }}</div>
                      <div class="mt-1 text-[13px] hint break-words" v-if="e.place">ğŸ“ {{ e.place }}</div>

                      <div class="mt-2 flex flex-wrap gap-2">
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          é‡‘é¡ï¼š{{ e.currency }} {{ money(e.amount) }}
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          ç´„ NT$ {{ money(e.amountTWD) }}
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          ç”± {{ personName(e.paidBy) }} æ”¯ä»˜
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          åˆ†æ”¤ {{ e.splitAmong.length }} äºº
                          <span v-if="hasCustomSplit(e)"> Â· å«è‡ªè¨‚</span>
                          <span v-else> Â· å¹³å‡ NT$ {{ money(e.amountTWD / Math.max(1,e.splitAmong.length)) }}</span>
                        </span>
                      </div>

                      <div class="mt-2 text-[13px] break-words" v-if="e.note">ğŸ“ {{ e.note }}</div>

                      <div class="mt-3" v-if="e.receipt">
                        <img :src="e.receipt" class="w-full max-h-56 object-cover rounded-2xl border"
                             style="border-color: var(--line);" />
                      </div>
                    </div>

                    <div class="flex flex-col gap-2 shrink-0">
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="editExpense(e)">
                        âœï¸
                      </button>
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="removeExpense(e.id)">
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- settlement -->
              <div class="mt-5 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <!-- âœ… åˆªæ‰ã€Œèª°æ¬ èª°ã€ä¸‰å€‹å­— -->
                  <div class="font-bold text-[16px]">ğŸ§¾ çµé¤˜</div>
                  <div class="text-[12px] hint">ä¾æŠ˜å°å¹£è¨ˆç®—</div>
                </div>
                <div class="mt-3 grid gap-2">
                  <div v-for="(line,idx) in settlementLines()" :key="'st-'+idx"
                       class="rounded-2xl p-3 border bg-white/70"
                       style="border-color: var(--line);">
                    {{ line }}
                  </div>
                  <div v-if="settlementLines().length===0" class="text-center hint py-4">
                    ç›®å‰å‰›å¥½éƒ½æ‰“å¹³ âœ¨
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- è¡Œæ -->
        <section v-show="tab==='luggage'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-bold text-[16px]">ğŸ’ è¡Œææ¸…å–®</div>
                  <div class="text-[13px] hint mt-1">å¯æ–°å¢é …ç›®ï¼›åˆªé™¤æ”¹æˆç´…è‰²ã€Œï¼ã€</div>
                </div>
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="openAddLuggage()">
                  â• æ–°å¢
                </button>
              </div>
            </div>

            <div class="p-4 space-y-4">
              <div v-for="cat in luggageCategories()" :key="cat" class="rounded-3xl p-4 bg-white/70 border"
                   style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold">ğŸ“¦ {{ cat }}</div>
                  <div class="text-[12px] hint">
                    {{ luggageItems(cat).filter(i=>i.done).length }}/{{ luggageItems(cat).length }}
                  </div>
                </div>

                <div class="mt-3 space-y-2">
                  <div v-for="it in luggageItems(cat)" :key="it.id"
                       class="flex items-center gap-2 rounded-2xl p-2 border bg-white/70"
                       style="border-color: var(--line);">
                    <input type="checkbox" v-model="it.done" @change="persist()"
                           class="w-5 h-5 accent-blue-500" />
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold truncate">{{ it.name }}</div>
                      <div class="text-[12px] hint" v-if="it.note">ğŸ“ {{ it.note }}</div>
                    </div>
                    <button class="w-9 h-9 rounded-2xl grid place-items-center border bg-white/70 hover:bg-white"
                            style="border-color: var(--line); color: #ef4444;"
                            @click="removeLuggage(it.id)">
                      ï¼
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>

        <!-- æ”¶è— -->
        <section v-show="tab==='fav'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">â­ æ”¶è—</div>
                  <div class="text-[13px] hint mt-1">åˆ†é¡å¯æ–°å¢ï¼›ä»¥ã€Œåœ°å€ã€è‡ªå‹•åˆ†çµ„</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                          @click="openFavCategoryManager=true">
                    ğŸ·ï¸ é¡å‹
                  </button>
                  <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                          @click="openAddFav()">
                    â• æ–°å¢
                  </button>
                </div>
              </div>

              <div class="mt-3 flex gap-2 overflow-x-auto pb-2">
                <button class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="favFilter==='' ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="favFilter=''">
                  å…¨éƒ¨
                </button>
                <button v-for="c in activeTrip.favCategories" :key="'fc-'+c"
                        class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="favFilter===c ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="favFilter=c">
                  {{ c }}
                </button>
              </div>
            </div>

            <div class="p-4">
              <div v-if="filteredFav().length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                é‚„æ²’æœ‰æ”¶è—ï½çœ‹åˆ°æƒ³å»çš„å°±å…ˆä¸Ÿé€²ä¾† âœ¨
              </div>

              <div class="space-y-4">
                <div v-for="group in favGroupedByArea()" :key="group.area"
                     class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                  <div class="flex items-center justify-between">
                    <div class="font-bold">ğŸ“ {{ group.area }}</div>
                    <div class="text-[12px] hint">{{ group.items.length }} ç­†</div>
                  </div>

                  <div class="mt-3 space-y-3">
                    <div v-for="it in group.items" :key="it.id"
                         class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                         style="border-color: var(--line);">
                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                          <div class="text-[12px] hint">ğŸ·ï¸ {{ it.category || "æœªåˆ†é¡" }} Â· ğŸ‘¤ {{ it.buyer || "â€”" }}</div>
                          <div class="mt-1 font-bold text-[16px] break-words">{{ it.name || "ï¼ˆæœªå¡«åç¨±ï¼‰" }}</div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <span class="text-[12px] px-2 py-1 rounded-xl chip">æ•¸é‡ï¼š{{ it.qty || 1 }}</span>
                            <span class="text-[12px] px-2 py-1 rounded-xl chip" v-if="it.price">
                              åƒ¹æ ¼ï¼š{{ it.currency || "KRW" }} {{ money(it.price) }}
                            </span>
                            <span class="text-[12px] px-2 py-1 rounded-xl chip" v-if="it.place">
                              åœ°é»ï¼š{{ it.place }}
                            </span>
                          </div>
                          <div class="mt-2 text-[13px] break-words" v-if="it.note">ğŸ“ {{ it.note }}</div>
                          <div class="mt-2 flex flex-wrap gap-2" v-if="(it.links||[]).length">
  <a v-for="(lk,idx) in it.links" :key="'itlk-'+it.id+'-'+idx"
     :href="lk.url" target="_blank"
     class="text-[12px] underline decoration-baby/60">
    ğŸ”— {{ (lk.label && lk.label.trim()) ? lk.label : lk.url }}
  </a>
</div>

                          <div class="mt-3" v-if="it.image">
                            <img :src="it.image" class="w-full max-h-56 object-cover rounded-2xl border"
                                 style="border-color: var(--line);" />
                          </div>
                        </div>

                        <div class="flex flex-col gap-2 shrink-0">
                          <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                  @click="editFav(it)">
                            âœï¸
                          </button>
                          <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                  @click="removeFav(it.id)">
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- è³‡è¨Š -->
        <section v-show="tab==='info'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">ğŸ“Œ å›ºå®šè³‡è¨Š & å‚™å¿˜éŒ„</div>
                </div>
                <div class="flex gap-2">
  <!-- âœ… æ–°å¢å›ºå®šè³‡è¨Šï¼ˆå·¦ï¼‰ -->
<button
  class="btnPrimary rounded-2xl px-4 py-2 text-[12px] font-semibold shadow-soft tap"
  @click="openAddInfoBlock()"
>
  <div class="leading-none">â• æ–°å¢</div>
  <div class="text-[11px] opacity-90 mt-0.5">å›ºå®šè³‡è¨Š</div>
</button> 

  <!-- âœ… æ–°å¢å‚™å¿˜ï¼ˆå³ï¼ŒåŸæœ¬çš„ï¼‰ -->
  <button
    class="btnPrimary rounded-2xl px-4 py-2 text-[12px] font-semibold shadow-soft inline-flex items-center gap-2 leading-none tap"
    @click="openAddNote()"
  >
    <span class="grid place-items-center w-5 h-5 text-[16px] leading-none">â•</span>
    <span class="leading-none">æ–°å¢å‚™å¿˜</span>
  </button>
</div>

            </div>

            <div class="p-4 space-y-4">
             <!-- Fixed info (editable) -->
<div class="space-y-3">

  <!-- âœ… ç©ºç‹€æ…‹æç¤ºï¼ˆåƒè‡ªç”±å‚™å¿˜éŒ„ä¸€æ¨£ï¼‰ -->
  <div v-if="(activeTrip.infoBlocks||[]).length===0"
       class="rounded-2xl p-4 border bg-white/65 text-center hint"
       style="border-color: var(--line);">
    å°šæœªæ–°å¢å›ºå®šè³‡è¨Šï½å¯ä»¥æ”¾èˆªç­ã€åœ°å€ã€é‡è¦è¯çµ¡äººã€Wi-Fi å¯†ç¢¼ âœ¨
  </div>

  <div v-for="b in activeTrip.infoBlocks" :key="b.id"
       class="rounded-3xl p-4 bg-white/70 border"
       style="border-color: var(--line);">

    <div class="flex items-start justify-between gap-2">
      <div class="font-bold text-[15px]">{{ b.title }}</div>

      <!-- âœ… å³å´å…©é¡†ï¼šç·¨è¼¯ + åˆªé™¤ -->
      <div class="flex gap-2">
        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                @click="editInfoBlock(b)">
          âœï¸
        </button>
        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                @click="removeInfoBlock(b.id)">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>

    <!-- âœ… å…§å®¹ï¼šç©ºç™½æ™‚é¡¯ç¤ºæç¤º -->
    <div class="mt-2 text-[13px] whitespace-pre-line"
         v-if="(b.content||'').trim()">
      {{ b.content }}
    </div>
    <div class="mt-2 text-[13px] hint"
         v-else>
      {{ b.hint || "å¯åœ¨é€™è£¡å¡«å¯«å›ºå®šè³‡è¨Šï¼ˆä¾‹å¦‚ï¼šèˆªç­ / åœ°å€ / è¯çµ¡æ–¹å¼ï¼‰" }}
    </div>

    <a v-if="b.link" class="mt-2 inline-block text-[12px] underline decoration-baby/60"
       :href="b.link" target="_blank">
      ğŸ”— é€£çµ
    </a>
  </div>
</div>

              <!-- Notes -->
              <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-[15px]">ğŸ“ è‡ªç”±å‚™å¿˜éŒ„</div>
                  <div class="text-[12px] hint">{{ activeTrip.notes.length }} ç­†</div>
                </div>

                <div class="mt-3 space-y-3">
                  <div v-if="activeTrip.notes.length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                       style="border-color: var(--line);">
                    å…ˆæŠŠçœ‹åˆ°çš„è³‡è¨Šä¸Ÿé€²ä¾†ï½åƒæ˜¯ã€Œæƒ³é€›çš„åº— / çªç„¶æƒ³åˆ°çš„æé†’ã€âœ¨
                  </div>

                  <div v-for="n in activeTrip.notes" :key="n.id"
                       class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                       style="border-color: var(--line);">
                    <div class="flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-[12px] hint mono">
                          ğŸ“… {{ n.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰" }} Â· ğŸ•’ {{ n.time || "ï¼ˆæœªå¡«æ™‚é–“ï¼‰" }}
                        </div>
                        <div class="mt-1 font-bold text-[16px] break-words">{{ n.title || "ï¼ˆæœªå¡«æ¨™é¡Œï¼‰" }}</div>
                        <div class="mt-1 text-[13px] hint break-words" v-if="n.place">ğŸ“ {{ n.place }}</div>
                        <div class="mt-2 text-[13px] break-words" v-if="n.note">ğŸ“ {{ n.note }}</div>

                        <div class="mt-2 flex flex-wrap gap-2" v-if="n.link || n.map">
                          <a v-if="n.link" :href="n.link" target="_blank"
                             class="text-[12px] underline decoration-baby/60">ğŸ”— ç¶²å€</a>
                          <a v-if="n.map" :href="n.map" target="_blank"
                             class="text-[12px] underline decoration-lavender/60">ğŸ—ºï¸ åœ°åœ–</a>
                        </div>

                        <div class="mt-3 grid grid-cols-3 gap-2" v-if="(n.images||[]).length">
                          <img v-for="(img,idx) in n.images" :key="idx" :src="img"
                               class="w-full aspect-square object-cover rounded-2xl border"
                               style="border-color: var(--line);" />
                        </div>
                      </div>

                      <div class="flex flex-col gap-2 shrink-0">
                        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                @click="editNote(n)">
                          âœï¸
                        </button>
                        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                @click="removeNote(n.id)">
                          ğŸ—‘ï¸
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </section>

        <!-- å¤©æ°£ -->
        <section v-show="tab==='weather'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">â˜ï¸ å¤©æ°£</div>
                  <div class="text-[13px] hint mt-1">é è¨­ Seoulï¼›ä¹Ÿå¯æ‰‹å‹•åˆ‡æ›åŸå¸‚</div>
                </div>
                <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                        @click="refreshWeather()">
                  ğŸ”„ æ›´æ–°
                </button>
              </div>

              <div class="mt-3 flex gap-2">
                <input class="input rounded-2xl px-3 py-2 w-full text-[13px]"
                       placeholder="è¼¸å…¥åŸå¸‚ï¼ˆä¾‹ï¼šSeoul / Tokyo / Osakaï¼‰"
                       v-model="weatherQuery"
                       @keydown.enter="searchCity()" />
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="searchCity()">
                  ğŸ”
                </button>
              </div>

              <div class="mt-2 text-[12px] hint" v-if="weatherStatus">{{ weatherStatus }}</div>
            </div>

            <div class="p-4">
              <div v-if="weather.current" class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                   style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-bold text-[16px]">ğŸ“ {{ weather.cityName }}</div>
                    <div class="text-[13px] hint mt-1">æ›´æ–°ï¼š{{ weather.updatedAt }}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-[40px] font-extrabold mono">{{ weather.current.temperature }}Â°</div>
                    <div class="text-[12px] hint">é¢¨ {{ weather.current.windspeed }} km/h</div>
                  </div>
                </div>
              </div>

              <div v-if="weather.daily?.length" class="mt-4 space-y-2">
                <div v-for="d in weather.daily" :key="d.date"
                     class="rounded-2xl p-3 border bg-white/70 flex items-center justify-between"
                     style="border-color: var(--line);">
                  <div>
                    <div class="font-semibold">{{ d.date }}</div>
                    <div class="text-[12px] hint">{{ d.weekday }}</div>
                  </div>
                  <div class="mono font-bold">{{ d.tmax }}Â° / {{ d.tmin }}Â°</div>
                </div>
              </div>

              <div v-if="!weather.current" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                ç›®å‰é‚„æ²’æœ‰è³‡æ–™ï½æŒ‰ã€Œæ›´æ–°ã€æˆ–æœå°‹åŸå¸‚ âœ¨
              </div>
            </div>

          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav v-if="activeTrip" class="fixed bottom-0 left-0 right-0 z-50">
    <div class="max-w-[460px] mx-auto px-4 pb-[env(safe-area-inset-bottom)]">
      <div class="glass rounded-[28px] shadow-soft border p-2 mb-3 bottomFloat"
           style="border-color: var(--line);">
        <div class="grid grid-cols-5 gap-1 text-[11px]">
  <button class="rounded-2xl py-2 flex flex-col items-center justify-center gap-0.5 leading-none tap"
          @click="tab='plan'"
          :class="tab==='plan'?'segActive':''">
    <span class="text-[18px] leading-none">ğŸ—“ï¸</span>
    <span class="text-[11px] leading-none">è¡Œç¨‹</span>
  </button>

  <button class="rounded-2xl py-2 flex flex-col items-center justify-center gap-0.5 leading-none tap"
          @click="tab='money'"
          :class="tab==='money'?'segActive':''">
    <span class="text-[18px] leading-none">ğŸ’¸</span>
    <span class="text-[11px] leading-none">è¨˜å¸³</span>
  </button>

  <button class="rounded-2xl py-2 flex flex-col items-center justify-center gap-0.5 leading-none tap"
          @click="tab='luggage'"
          :class="tab==='luggage'?'segActive':''">
    <span class="text-[18px] leading-none">ğŸ’</span>
    <span class="text-[11px] leading-none">è¡Œæ</span>
  </button>

  <button class="rounded-2xl py-2 flex flex-col items-center justify-center gap-0.5 leading-none tap"
          @click="tab='fav'"
          :class="tab==='fav'?'segActive':''">
    <span class="text-[18px] leading-none">â­</span>
    <span class="text-[11px] leading-none">æ”¶è—</span>
  </button>

  <button class="rounded-2xl py-2 flex flex-col items-center justify-center gap-0.5 leading-none tap"
          @click="tab='info'"
          :class="tab==='info'?'segActive':''">
    <span class="text-[18px] leading-none">ğŸ“Œ</span>
    <span class="text-[11px] leading-none">è³‡è¨Š</span>
  </button>
</div>
      </div>
    </div>
  </nav>

  <!-- Modals -->
  <!-- Trip catalog modal -->
  <div v-if="openTripCatalog" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openTripCatalog=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">ğŸ“š è¡Œç¨‹ç›®éŒ„</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openTripCatalog=false">âœ–</button>
      </div>

      <div class="mt-3 space-y-3 max-h-[70vh] overflow-auto pr-1">
        <button class="w-full text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                style="border-color: var(--line);"
                @click="startCreateTrip()">
          <div class="font-bold">â• æ–°å¢è¡Œç¨‹</div>
          <div class="text-[13px] hint mt-1">å»ºç«‹æ–°çš„æ—…éŠè¨ˆç•«ï¼ˆå¯è¨­å®šé ­åƒ/æ—¥æœŸ/äººå“¡/èˆªç­ï¼‰</div>
        </button>
<!-- Backup / Restore -->
<div class="mt-4 rounded-3xl p-4 bg-white/70 border"
     style="border-color: var(--line);">

  <div class="font-semibold mb-2">ğŸ’¾ è³‡æ–™å‚™ä»½</div>

  <div class="flex gap-2 flex-wrap">
    <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
            @click="exportData()">
      â¬‡ï¸ åŒ¯å‡ºå‚™ä»½
    </button>

    <label class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white shadow-soft cursor-pointer">
      â¬†ï¸ åŒ¯å…¥å‚™ä»½
      <input type="file" accept=".json"
             class="hidden"
             @change="importData($event)">
    </label>
  </div>

  <div class="text-[12px] text-gray-500 mt-2">
    âš ï¸ åŒ¯å…¥æœƒè¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼Œè«‹ç¢ºèªå‚™ä»½æª”æ­£ç¢º
  </div>
</div>

        <button v-for="t in store.trips" :key="'m-'+t.id"
                class="w-full text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                style="border-color: var(--line);"
                @click="selectTrip(t.id); openTripCatalog=false">
          <div class="flex gap-3 items-center">
            <div class="w-12 h-12 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
              <img v-if="t.avatar" :src="t.avatar" class="w-full h-full object-cover" alt="">
              <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
            </div>
            <div class="min-w-0 flex-1">
              <div class="font-bold truncate">{{ t.title }}</div>
              <div class="text-[13px] hint mt-0.5">ğŸ“… {{ t.startDate }} â†’ {{ t.endDate }}</div>
            </div>
            <div class="text-[20px]">â€º</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Trip settings -->
  <div v-if="openTripSettings" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openTripSettings=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4
            max-h-[85vh] overflow-y-auto"
     style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">âš™ï¸ è¡Œç¨‹è¨­å®š</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openTripSettings=false">âœ–</button>
      </div>

      <div class="mt-4 space-y-3">
        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="font-semibold">ğŸ–¼ï¸ è¡Œç¨‹é ­åƒ</div>
          <div class="mt-2 flex items-center gap-3">
            <div class="w-16 h-16 rounded-3xl overflow-hidden border bg-white" style="border-color: var(--line);">
              <img v-if="activeTrip.avatar" :src="activeTrip.avatar" class="w-full h-full object-cover" alt="">
              <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
            </div>
            <div class="flex-1">
              <input type="file" accept="image/*" @change="onPickTripAvatar($event)" class="text-[13px]"/>
              <div class="text-[12px] hint mt-1">é¸å¥½æœƒè·³å‡ºè£åˆ‡ï¼Œå¯èª¿æ•´ä½ç½®</div>
            </div>
          </div>
        </div>
<!-- âœ… èƒŒæ™¯è¨­å®š -->
<div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
  <div class="flex items-center justify-between">
    <div class="font-semibold">ğŸ¨ èƒŒæ™¯</div>
    <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white tap"
            @click="removeTripBackground()">
      ç§»é™¤
    </button>
  </div>

  <div class="mt-2 text-[12px] hint">
    å¯ä¸Šå‚³ä¸€å¼µç•¶è¡Œç¨‹èƒŒæ™¯ï¼ˆæœƒè‡ªå‹•æ·¡åŒ–+æ¨¡ç³Šï¼Œä¸å½±éŸ¿é–±è®€ï¼‰
  </div>

  <div class="mt-3 grid gap-3">
    <input type="file" accept="image/*" @change="onPickTripBackground($event)" class="text-[13px]"/>

    <div>
      <div class="flex items-center justify-between">
        <div class="text-[13px] font-semibold">æ¿ƒæ·¡</div>
        <div class="text-[12px] hint mono">{{ Number(activeTrip.bgOpacity ?? 0.22).toFixed(2) }}</div>
      </div>
      <input type="range" min="0" max="0.5" step="0.01"
             v-model.number="activeTrip.bgOpacity"
             @input="persist(); applyTripBackground()"
             class="w-full">
    </div>

    <div v-if="activeTrip.bgPhoto" class="rounded-3xl overflow-hidden border bg-white" style="border-color: var(--line);">
      <img :src="activeTrip.bgPhoto" class="w-full h-32 object-cover" alt="">
    </div>
  </div>
</div>

        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="font-semibold">ğŸ“ åç¨± / æ—¥æœŸ</div>
          <div class="mt-2 grid gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="activeTrip.title" placeholder="è¡Œç¨‹åç¨±ï¼ˆä¾‹å¦‚ï¼šé¦–çˆ¾/æ±äº¬ï¼‰" @input="persist()">
            <div class="grid grid-cols-2 gap-2">
              <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="activeTrip.startDate" @change="syncDaysAfterTripEdit()">
              <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="activeTrip.endDate" @change="syncDaysAfterTripEdit()">
            </div>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="activeTrip.city" placeholder="é è¨­åŸå¸‚ï¼ˆSeoul / Tokyo ...ï¼‰" @input="persist()">
          </div>
        </div>

        <!-- âœ… èˆªç­ç®¡ç† -->
        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="flex items-center justify-between">
            <div class="font-semibold">âœˆï¸ èˆªç­</div>
            <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                    @click="startAddFlight()">
              â• æ–°å¢èˆªç­
            </button>
          </div>

          <div class="mt-3 grid gap-2">
            <div v-for="f in (activeTrip.flights||[])" :key="f.id"
                 class="rounded-2xl p-3 border bg-white/70 flex items-start justify-between gap-2"
                 style="border-color: var(--line);">
              <div class="min-w-0">
                <div class="font-semibold">{{ f.depAirport || "â€”" }} â†’ {{ f.arrAirport || "â€”" }}</div>
                <div class="text-[12px] hint mono">{{ f.type || "èˆªç­" }} Â· {{ f.date || "" }} Â· {{ f.depTime || "â€”" }} â†’ {{ f.arrTime || "â€”" }}</div>
                <div class="text-[12px] hint" v-if="f.flightNo">èˆªç­ï¼š{{ f.flightNo }}</div>
              </div>
              <div class="flex gap-2">
                <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                        @click="editFlight(f)">âœï¸</button>
                <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                        @click="removeFlight(f.id)">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div v-if="(activeTrip.flights||[]).length===0" class="rounded-2xl p-3 border bg-white/65 text-center hint"
                 style="border-color: var(--line);">
              é‚„æ²’æ–°å¢èˆªç­ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨
            </div>
          </div>
        </div>

        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="flex items-center justify-between">
            <div class="font-semibold">ğŸ‘¥ åƒèˆ‡äººå“¡</div>
            <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                    @click="startAddPerson()">
              â• æ–°å¢äººå“¡
            </button>
          </div>

          <div class="mt-3 grid gap-2">
            <div v-for="p in activeTrip.people" :key="p.id"
                 class="flex items-center gap-3 rounded-2xl p-2 border bg-white/70"
                 style="border-color: var(--line);">
              <div class="w-11 h-11 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="p.avatar" :src="p.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">{{ p.name }}</div>
              </div>
              <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                      @click="editPerson(p)">
                âœï¸
              </button>
              <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                      @click="removePerson(p.id)">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                  @click="backToCatalog()">
            â†©ï¸ å›ç›®éŒ„
          </button>
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white"
                  style="color:#ef4444;"
                  @click="deleteTrip(activeTrip.id)">
            åˆªé™¤è¡Œç¨‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Currency Manager -->
  <div v-if="openCurrencyManager" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openCurrencyManager=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between gap-2">
        <div class="font-bold text-[16px]">ğŸ’± åŒ¯ç‡è¨­å®š</div>
        <div class="flex items-center gap-2">
          <!-- âœ… è‡ªå‹•æŠ“åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•æ”¹ï¼‰ -->
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
        @click="autoUpdateRates()">
  ğŸ”„ è‡ªå‹•æ›´æ–°
</button>

<!-- âœ… æ–°å¢ï¼šå¯¦æ™‚åŒ¯ç‡ï¼ˆé–‹ MSN åŒ¯ç‡æ›ç®—å™¨ï¼‰ -->
<button
  class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
  @click="openRateLink()"
>
  ğŸ“ˆ å¯¦æ™‚åŒ¯ç‡
</button>

<button class="btnPrimary rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
        @click="openCurrencyManager=false">
  âœ–
</button>
        </div>
      </div>

      <div class="mt-3 text-[13px] hint">
        åŒ¯ç‡æ˜¯ã€Œ1 å–®ä½å¤–å¹£ = å¤šå°‘å°å¹£ã€ã€‚ä¾‹å¦‚ KRW 0.0212 è¡¨ç¤º â‚â‚€â‚€â‚€ KRW â‰ˆ 21.2 TWD
      </div>

      <div class="mt-4 space-y-2 max-h-[55vh] overflow-auto pr-1">
        <div v-for="c in activeTrip.currencies" :key="c.code"
             class="rounded-2xl p-3 border bg-white/70 flex items-center gap-2"
             style="border-color: var(--line);">
          <div class="font-bold w-14">{{ c.code }}</div>
          <input class="input rounded-2xl px-3 py-2 text-[13px] flex-1"
                 v-model="c.name" placeholder="åç¨±ï¼ˆé¸å¡«ï¼‰" @input="persist()">
          <input class="input rounded-2xl px-3 py-2 text-[13px] w-28 mono"
                 type="number" step="0.000001" v-model.number="c.rateToTWD" @input="persist()">
          <button v-if="c.code!=='TWD'" class="w-10 h-10 rounded-2xl border bg-white/70 hover:bg-white"
                  style="border-color: var(--line); color:#ef4444;"
                  @click="removeCurrency(c.code)">
            ï¼
          </button>
        </div>
      </div>

      <div class="mt-4 rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
        <div class="font-semibold">â• æ–°å¢å¹£åˆ¥</div>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="newCur.code" placeholder="ä»£ç¢¼(å¦‚ JPY)">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="newCur.name" placeholder="åç¨±(é¸å¡«)">
          <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.000001"
                 v-model.number="newCur.rateToTWD" placeholder="åŒ¯ç‡">
        </div>
        <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft mt-3"
                @click="addCurrency()">
          æ–°å¢
        </button>
      </div>
    </div>
  </div>

  <!-- Fav category manager -->
  <div v-if="openFavCategoryManager" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openFavCategoryManager=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">ğŸ·ï¸ æ”¶è—é¡å‹</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openFavCategoryManager=false">âœ–</button>
      </div>

      <div class="mt-4 space-y-2">
        <div v-for="c in activeTrip.favCategories" :key="'cat-'+c"
             class="rounded-2xl p-3 border bg-white/70 flex items-center justify-between"
             style="border-color: var(--line);">
          <div class="font-semibold">{{ c }}</div>
          <button class="w-10 h-10 rounded-2xl border bg-white/70 hover:bg-white"
                  style="border-color: var(--line); color:#ef4444;"
                  @click="removeFavCategory(c)">
            ï¼
          </button>
        </div>
      </div>

      <div class="mt-4 rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
        <div class="font-semibold">â• æ–°å¢é¡å‹</div>
        <div class="mt-2 flex gap-2">
          <input class="input rounded-2xl px-3 py-2 text-[13px] flex-1" v-model="newFavCategory" placeholder="ä¾‹å¦‚ï¼šæ‹‰éºµ / å’–å•¡ / é€›è¡—">
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                  @click="addFavCategory()">
            æ–°å¢
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic editor modal -->
  <div v-if="editor.open" class="fixed inset-0 z-[70] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="closeEditor()"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">{{ editor.title }}</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="closeEditor()">âœ–</button>
      </div>

      <div class="mt-4 space-y-3 max-h-[70vh] overflow-auto pr-1">
<!-- âœ… infoBlock -->
<template v-if="editor.type==='infoBlock'">
  <input class="input rounded-2xl px-3 py-2 text-[13px]"
         v-model="editor.data.title" placeholder="æ¨™é¡Œï¼ˆä¾‹ï¼šğŸ¤ æ¼”å”±æœƒï¼‰">

  <input class="input rounded-2xl px-3 py-2 text-[13px]"
         v-model="editor.data.link" placeholder="é€£çµï¼ˆå¯ç©ºï¼‰">

  <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[160px]"
            v-model="editor.data.content" placeholder="å…§å®¹ï¼ˆå¯æ›è¡Œï¼‰"></textarea>
</template>
        <!-- plan/note -->
        <template v-if="editor.type==='plan' || editor.type==='note'">
          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='note'">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.time" placeholder="æ™‚é–“ï¼ˆä¾‹ 11:30ï¼‰">
          </div>

         <div class="grid grid-cols-2 gap-2" v-if="editor.type==='plan'">
  <select class="input rounded-2xl px-3 py-2 text-[13px]"
          v-model="editor.data.date">
    <option value="">ï¼ˆå¾…æ”¾å€ï¼‰</option>
    <option v-for="d in tripDays(activeTrip)" :key="d" :value="d">
      {{ d }}
    </option>
  </select>
</div>

            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.time" placeholder="æ™‚é–“ï¼ˆä¾‹ 11:30ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆä¾‹ åˆé¤ï¼‰">

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.title" placeholder="æ¨™é¡Œï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="åœ°é»ï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.map" placeholder="åœ°åœ–é€£çµï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.link" placeholder="ç¶²å€ï¼ˆå¯ç©ºï¼‰">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ–¼ï¸ åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" multiple @change="onAddImagesToEditor($event)">
            <div class="mt-3 grid grid-cols-3 gap-2" v-if="(editor.data.images||[]).length">
              <div v-for="(img,idx) in editor.data.images" :key="'ei-'+idx" class="relative">
                <img :src="img" class="w-full aspect-square object-cover rounded-2xl border" style="border-color: var(--line);">
                <button class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-white border shadow-soft grid place-items-center"
                        style="border-color: var(--line);"
                        @click="editor.data.images.splice(idx,1)">
                  âœ–
                </button>
              </div>
            </div>
          </div>
        </template>

        <!-- expense -->
        <template v-if="editor.type==='expense'">
          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆé¤é£²/äº¤é€šâ€¦ï¼‰">
          </div>
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.title" placeholder="é …ç›®ï¼ˆä¾‹ æ‹‰éºµï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="åœ°é»ï¼ˆå¯ç©ºï¼‰">

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.currency">
              <option v-for="c in activeTrip.currencies" :key="'cur-'+c.code" :value="c.code">{{ c.code }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.01" v-model.number="editor.data.amount" placeholder="é‡‘é¡">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.method">
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
            </select>
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.paidBy">
              <option v-for="p in activeTrip.people" :key="'pp-'+p.id" :value="p.id">{{ p.name }}</option>
            </select>
          </div>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ‘¥ åˆ†æ”¤äººå“¡</div>
            <div class="text-[12px] hint mt-1">âœ… å¯åœ¨å§“åå¾Œè¼¸å…¥ã€Œè‡ªè¨‚ NT$ã€ï¼›æ²’å¡«çš„äººæœƒå¹³åˆ†å‰©é¤˜é‡‘é¡</div>

            <div class="mt-3 grid gap-2">
              <div v-for="p in activeTrip.people" :key="'sp-'+p.id"
                   class="rounded-2xl p-2 border bg-white/70"
                   style="border-color: var(--line);">
                <div class="flex items-center gap-2">
                  <input type="checkbox" :value="p.id" v-model="editor.data.splitAmong"
                         class="w-5 h-5 accent-blue-500">
                  <span class="font-semibold flex-1">{{ p.name }}</span>

                  <!-- âœ… è‡ªè¨‚åˆ†æ”¤ -->
                  <input class="input rounded-2xl px-2 py-1 text-[12px] mono w-28"
                         type="number" step="1"
                         :disabled="!editor.data.splitAmong.includes(p.id)"
                         v-model.number="editor.data.splitCustom[p.id]"
                         placeholder="è‡ªè¨‚NT$" />
                </div>
              </div>
            </div>

            <div class="mt-3 rounded-2xl p-3 border bg-white/70" style="border-color: var(--line);">
              <div class="text-[13px] hint">
                é ä¼°åˆ†æ”¤ï¼š{{ previewSplitText(editor.data) }}
              </div>
            </div>
          </div>

          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ§¾ æ”¶æ“š/ç…§ç‰‡ï¼ˆå¯ç©ºï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" @change="onPickReceipt($event)">
            <div class="mt-3" v-if="editor.data.receipt">
              <img :src="editor.data.receipt" class="w-full max-h-56 object-cover rounded-2xl border" style="border-color: var(--line);">
            </div>
          </div>
        </template>

        <!-- âœ… flight -->
        <template v-if="editor.type==='flight'">
          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.type">
              <option>å»ç¨‹</option>
              <option>å›ç¨‹</option>
              <option>å…¶ä»–</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.depAirport" placeholder="å‡ºç™¼æ©Ÿå ´ï¼ˆä¾‹ TPE T1ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.arrAirport" placeholder="æŠµé”æ©Ÿå ´ï¼ˆä¾‹ ICN T2ï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" v-model="editor.data.depTime" placeholder="å‡ºç™¼æ™‚é–“ï¼ˆä¾‹ 12:25ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" v-model="editor.data.arrTime" placeholder="æŠµé”æ™‚é–“ï¼ˆä¾‹ 15:50ï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.flightNo" placeholder="èˆªç­è™Ÿï¼ˆå¯ç©ºï¼‰">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>
        </template>

        <!-- fav / shop -->
        <template v-if="editor.type==='fav' || editor.type==='shop'">
          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.area" placeholder="åœ°å€ï¼ˆä¾‹ æ±Ÿå— / å¼˜å¤§ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="è³¼ç‰©åœ°é»/åº—åï¼ˆå¯ç©ºï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='fav'">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category">
              <option value="">ï¼ˆæœªåˆ†é¡ï¼‰</option>
              <option v-for="c in activeTrip.favCategories" :key="'fop-'+c" :value="c">{{ c }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.buyer" placeholder="è³¼è²·äººï¼ˆå¯ç©ºï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='shop'">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.buyer" placeholder="è³¼è²·äººï¼ˆå¯ç©ºï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" v-model.number="editor.data.qty" placeholder="æ•¸é‡ï¼ˆé è¨­ 1ï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="å•†å“/åº—åï¼ˆå¯ç©ºï¼‰">

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.currency">
              <option v-for="c in activeTrip.currencies" :key="'fc2-'+c.code" :value="c.code">{{ c.code }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.01"
                   v-model.number="editor.data.price" placeholder="åƒ¹æ ¼ï¼ˆå¯ç©ºï¼‰">
          </div>

          <!-- âœ… å¤šç¶²å€ï¼ˆå¯æ–°å¢å¤šç­† + å¯å‘½åï¼‰ -->
<div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
  <div class="flex items-center justify-between">
    <div class="font-semibold">ğŸ”— ç¶²å€ï¼ˆå¯å¤šç­†ï¼‰</div>
    <button type="button"
            class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
            @click="addLinkRow()">
      â• æ–°å¢ç¶²å€
    </button>
  </div>

  <div class="mt-3 grid gap-2" v-if="(editor.data.links||[]).length">
    <div v-for="(lk,idx) in editor.data.links" :key="'lk-'+idx"
         class="rounded-2xl p-3 border bg-white/70"
         style="border-color: var(--line);">

      <div class="grid grid-cols-3 gap-2">
        <input class="input rounded-2xl px-3 py-2 text-[13px] col-span-1"
               v-model="lk.label"
               placeholder="åç¨±ï¼ˆå¯ç©ºï¼‰" />
        <input class="input rounded-2xl px-3 py-2 text-[13px] col-span-2"
               v-model="lk.url"
               placeholder="ç¶²å€ï¼ˆå¿…å¡«ï¼‰" />
      </div>

      <div class="mt-2 flex items-center justify-between">
        <a v-if="lk.url"
           :href="lk.url"
           target="_blank"
           class="text-[12px] underline decoration-baby/60">
          é è¦½ï¼š{{ (lk.label && lk.label.trim()) ? lk.label : lk.url }}
        </a>

        <button type="button"
                class="w-10 h-10 rounded-2xl border bg-white/70 hover:bg-white"
                style="border-color: var(--line); color:#ef4444;"
                @click="editor.data.links.splice(idx,1)">
          ï¼
        </button>
      </div>

    </div>
  </div>

  <div v-else class="text-[12px] hint mt-2">
    é‚„æ²’æœ‰ç¶²å€ï½æŒ‰å³ä¸Šè§’ã€Œæ–°å¢ç¶²å€ã€å¯ä»¥åŠ å¤šç­†
  </div>
</div>

          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ–¼ï¸ åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" @change="onPickSingleImageToEditor($event)">
            <div class="mt-3" v-if="editor.data.image">
              <img :src="editor.data.image" class="w-full max-h-56 object-cover rounded-2xl border" style="border-color: var(--line);">
            </div>
          </div>
        </template>

        <!-- luggage add -->
        <template v-if="editor.type==='luggage'">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆä¾‹ å¿…éœ€å“/è—¥å“â€¦ï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="é …ç›®åç¨±">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[80px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>
        </template>

        <!-- person -->
        <template v-if="editor.type==='person'">
          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ™‚ äººå“¡é ­åƒ</div>
            <div class="mt-2 flex items-center gap-3">
              <div class="w-16 h-16 rounded-3xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="editor.data.avatar" :src="editor.data.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
              </div>
              <div class="flex-1">
                <input type="file" accept="image/*" @change="onPickPersonAvatar($event)" class="text-[13px]"/>
                <div class="text-[12px] hint mt-1">é¸å¥½æœƒè·³å‡ºè£åˆ‡ï¼Œç«‹å³çœ‹åˆ°æœ‰æ²’æœ‰é¸åˆ°ä½ è¦çš„ä½ç½®</div>
              </div>
            </div>
          </div>
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="åå­—ï¼ˆå¿…å¡«ï¼‰">
        </template>
      </div>

      <div class="mt-4 flex gap-2">
        <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                @click="closeEditor()">
          å–æ¶ˆ
        </button>
        <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft flex-1"
                @click="saveEditor()">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- Cropper modal -->
  <div v-if="crop.open" class="fixed inset-0 z-[80] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/35" @click="closeCropper(false)"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">âœ‚ï¸ è£åˆ‡ç…§ç‰‡</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="closeCropper(false)">âœ–</button>
      </div>

      <div class="mt-4">
        <div class="text-[13px] hint">æ‹–æ›³ç§»å‹•ã€æ‹‰æ¡¿ç¸®æ”¾ï¼ˆæœƒå­˜æˆæ–¹å½¢é ­åƒï¼‰</div>

        <div class="mt-3 rounded-3xl border overflow-hidden bg-white shadow-soft"
             style="border-color: var(--line);">
          <div class="relative w-full aspect-square bg-slate-50 overflow-hidden"
               @pointerdown="cropPointerDown"
               @pointermove="cropPointerMove"
               @pointerup="cropPointerUp"
               @pointercancel="cropPointerUp">
            <img v-if="crop.imgSrc" :src="crop.imgSrc"
                 class="absolute left-1/2 top-1/2 select-none pointer-events-none"
                 :style="cropImgStyle()"
                 draggable="false" />
            <div class="absolute inset-0 ring-1 ring-white/40"></div>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <div class="text-[12px] hint w-10">ğŸ”</div>
          <input type="range" min="1" max="3" step="0.01" v-model.number="crop.scale" class="w-full">
          <div class="text-[12px] hint w-12 mono">{{ crop.scale.toFixed(2) }}x</div>
        </div>

        <div class="mt-4 flex gap-2">
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                  @click="closeCropper(false)">
            å–æ¶ˆ
          </button>
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft flex-1"
                  @click="closeCropper(true)">
            ä½¿ç”¨æ­¤è£åˆ‡
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const { createApp } = Vue;

createApp({
  data(){
    return {
      tab: "plan",
      nowText: "",
      store: this.loadStore(),

      openTripCatalog: false,
      openTripSettings: false,
      openCurrencyManager: false,
      openFavCategoryManager: false,

      activeTripId: "",
      activeDay: "",
      selectedExpenseDay: "",
      favFilter: "",

      editor: { open:false, type:"", title:"", data:{}, mode:"new", refId:"" },

      // currencies add
      newCur: { code:"", name:"", rateToTWD: 1 },

      // fav category add
      newFavCategory: "",

      // weather
      weatherQuery: "",
      weatherStatus: "",
      weather: { cityName:"", updatedAt:"", current:null, daily:[] },

      // cropper
      crop: {
        open:false,
        imgSrc:"",
        scale: 1.4,
        offX: 0,
        offY: 0,
        dragging:false,
        px:0, py:0,
        callback: null
      }
    }
  },
  computed:{
    activeTrip(){
      return this.store.trips.find(t=>t.id===this.activeTripId) || null;
    }
  },
  mounted(){
    this.tickNow();
    setInterval(this.tickNow, 1000*30);

    const last = localStorage.getItem("tripbook_activeTripId_v2");
    if (last && this.store.trips.some(t=>t.id===last)) {
      this.activeTripId = last;
      this.afterTripSelected();
    }
  },
 methods:{
  editInfoBlock(b){
    this.editor = {
      open:true,
      type:"infoBlock",
      title:"âœï¸ ç·¨è¼¯å›ºå®šè³‡è¨Š",
      mode:"edit",
      refId:b.id,
      data: JSON.parse(JSON.stringify(b))
    };
  },

addLinkRow(){
  this.editor.data.links ||= [];
  this.editor.data.links.push({ label:"", url:"" });
},
openAddInfoBlock(){
  this.editor = {
    open:true,
    type:"infoBlock",
    title:"â• æ–°å¢å›ºå®šè³‡è¨Š",
    mode:"new",
    refId:"",
    data:{
      id:this.uid(),
      title:"",
      content:"",
      link:"",
      hint:"å¯å¡«ï¼šèˆªç­ / åœ°å€ / Wi-Fi / é‡è¦è¯çµ¡äºº / æ³¨æ„äº‹é …"
    }
  };
},
removeInfoBlock(id){
  if(!confirm("åˆªé™¤æ­¤å›ºå®šè³‡è¨Šï¼Ÿ")) return;
  this.activeTrip.infoBlocks = (this.activeTrip.infoBlocks||[]).filter(x=>x.id!==id);
  this.persist();
},

  exportData(){
    const dataStr = JSON.stringify(this.store, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "tripbook_backup.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
  },

  async importData(event){
    const file = event.target.files?.[0];
    if(!file) return;

    try{
      const text = await file.text();
      const json = JSON.parse(text);

      if(!json || !Array.isArray(json.trips)){
        alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„å‚™ä»½æª”");
        return;
      }

      this.store = json;
      this.persist();
      alert("åŒ¯å…¥å®Œæˆï¼");
    }catch(e){
      alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦æ­£ç¢º");
    }

    event.target.value = "";
  },

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä½ åŸæœ¬çš„ loadStore()ã€persist()ã€å¾Œé¢æ‰€æœ‰ methods éƒ½æ¥åœ¨é€™è¡Œä¸‹é¢


    // ---------- store ----------
    loadStore(){
      const raw = localStorage.getItem("tripbook_store_v2");
      if(raw){
        try{ return JSON.parse(raw); }catch(e){}
      }
      return { trips: [] };
    },
applyTripBackground(){
  const photo = this.activeTrip?.bgPhoto || "";
  const op = Number(this.activeTrip?.bgOpacity ?? 0.22);

  document.documentElement.style.setProperty(
    "--bg-photo",
    photo ? `url(${photo})` : "none"
  );
  document.documentElement.style.setProperty(
    "--bg-photo-opacity",
    String(Math.min(0.5, Math.max(0, op)))
  );
},

async onPickTripBackground(ev){
  const f = (ev.target.files || [])[0];
  if(!f) return;
  const src = await this.readFileAsDataURL(f);
  this.activeTrip.bgPhoto = src;
  this.persist();
  this.applyTripBackground();
  ev.target.value = "";
},

removeTripBackground(){
  this.activeTrip.bgPhoto = "";
  this.activeTrip.bgOpacity = 0.22;
  this.persist();
  this.applyTripBackground();
},

    persist(){
      localStorage.setItem("tripbook_store_v2", JSON.stringify(this.store));
      if(this.activeTripId) localStorage.setItem("tripbook_activeTripId_v2", this.activeTripId);
    },
    uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); },
    seedInfoBlocks(){
  return [
    {
      id: this.uid(),
      key: "flight",
      title: "âœˆï¸ èˆªç­",
      content: "", // âœ… é è¨­ç©ºç™½
      link: "",
      hint: "å¯å¡«ï¼šå»å›ç¨‹æ™‚é–“ã€èˆªç­è™Ÿã€å‡ºå…¥å¢ƒæ³¨æ„äº‹é …ï¼ˆä¾‹ï¼šææ—©åˆ°æ©Ÿå ´ã€è¡Œæé™åˆ¶ï¼‰"
    }
  ];
},



    // ---------- time ----------
    tickNow(){
      const d = dayjs();
      this.nowText = d.format("YYYY/MM/DD HH:mm");
    },
    daysUntil(dateStr){
      const a = dayjs().startOf('day');
      const b = dayjs(dateStr).startOf('day');
      return b.diff(a,'day');
    },
    md(dateStr){ return dayjs(dateStr).format("M/D"); },
    dow(dateStr){
      const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      return "é€±" + map[dayjs(dateStr).day()];
    },

    // ---------- trip days ----------
    tripDays(trip){
      const out=[];
      let d = dayjs(trip.startDate);
      const end = dayjs(trip.endDate);
      while(d.isBefore(end) || d.isSame(end,'day')){
        out.push(d.format("YYYY-MM-DD"));
        d = d.add(1,'day');
      }
      return out;
    },
    ensureTripShape(t){
      t.people ||= [];
      t.itinerary ||= {};
      t.itinerary._unscheduled ||= [];
      t.expenses ||= [];
      t.notes ||= [];
      t.infoBlocks ||= this.seedInfoBlocks();
    if(!t.infoBlocks.length) t.infoBlocks = this.seedInfoBlocks();
      t.favCategories ||= ["åƒé£¯","å’–å•¡","é€›è¡—","æ™¯é»","è²·è²·","ä»£è³¼"];
      t.fav ||= [];
      t.shop ||= [];
      t.luggage ||= [];
      t.flights ||= [];
      t.currencies ||= [
        { code:"TWD", name:"å°å¹£", rateToTWD: 1 },
        { code:"KRW", name:"éŸ“å…ƒ", rateToTWD: 0.0212 },
        { code:"JPY", name:"æ—¥åœ“", rateToTWD: 0.2033 }
      ];
      t.bgPhoto ||= "";          // èƒŒæ™¯åœ–ï¼ˆDataURLï¼‰
      t.bgOpacity ||= 0.22;      // èƒŒæ™¯æ¿ƒæ·¡

      t.city ||= "Seoul";
      for(const d of this.tripDays(t)){
  if(!t.itinerary[d]) t.itinerary[d]=[];
}

if(!this.activeDay){
  this.activeDay = this.tripDays(t)[0] || "_unscheduled";
}
}, // âœ… ensureTripShape çµæŸï¼Œé€™è£¡æ‰æ˜¯ methods ä¹‹é–“çš„é€—è™Ÿ

selectTrip(id){
      this.activeTripId = id;
      this.afterTripSelected();
      this.tab = "plan";
      this.persist();
    },
    afterTripSelected(){
      if(!this.activeTrip) return;
      this.ensureTripShape(this.activeTrip);
      const days = this.tripDays(this.activeTrip);
const ok = (this.activeDay==="_unscheduled") || days.includes(this.activeDay);
this.activeDay = ok ? this.activeDay : (days[0] || "_unscheduled");
      this.selectedExpenseDay = "";
      this.favFilter = "";
      this.$nextTick(()=> this.mountSortable());
      this.weatherQuery = this.activeTrip.city || "Seoul";
      this.refreshWeather();
      this.applyTripBackground();
    },
    backToCatalog(){
      this.activeTripId = "";
      this.tab = "plan";
      this.openTripSettings=false;
      this.persist();
      document.documentElement.style.setProperty("--bg-photo", "none");
    },
    deleteTrip(id){
      if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) return;
      this.store.trips = this.store.trips.filter(t=>t.id!==id);
      this.activeTripId = "";
      this.persist();
      this.openTripSettings=false;
    },

    startCreateTrip(){
      const t = {
        id: this.uid(),
        title: "My Travel",
        avatar: "",
        startDate: "YYYY-MM-DD",
        endDate: "YYYY-MM-DD",
        city: "Seoul",
        people: [
          { id: this.uid(), name: "æˆ‘", avatar: "" }
        ],
        flights: [
          { id:this.uid(), type:"å»ç¨‹", date:"YYYY-MM-DD", depAirport:"TPE T1", arrAirport:"TPE T2", depTime:"00:00", arrTime:"00:00", flightNo:"", note:"" },
          { id:this.uid(), type:"å›ç¨‹", date:"YYYY-MM-DD", depAirport:"TPE T2", arrAirport:"TPE T1", depTime:"00:00", arrTime:"00:00", flightNo:"" }
        ],
        currencies: [
          { code:"TWD", name:"å°å¹£", rateToTWD: 1 },
          { code:"KRW", name:"éŸ“å…ƒ", rateToTWD: 0.0212 },
          { code:"JPY", name:"æ—¥åœ“", rateToTWD: 0.22 }
        ],
        itinerary: {},
        expenses: [],
        notes: [],
        infoBlocks: [],
        favCategories: ["åƒé£¯","å’–å•¡","é€›è¡—","æ™¯é»","è²·è²·","ä»£è³¼"],
        fav: [],
        shop: [],
        luggage: this.seedLuggage()
      };
      this.store.trips.unshift(t);
      this.ensureTripShape(t);
      this.activeTripId = t.id;
      this.openTripCatalog=false;
      this.persist();
      this.afterTripSelected();
      this.openTripSettings=true;
    },

    // ---------- UI helpers ----------
    segClass(key){ return (this.tab===key) ? "segActive" : "bg-white/70 hover:bg-white"; },
    money(n){
      const x = Number(n||0);
      return x.toLocaleString("zh-Hant", { maximumFractionDigits: 0 });
    },

    // ---------- luggage ----------
    seedLuggage(){
      const add = (cat, name, note="") => ({ id:this.uid(), category:cat, name, note, done:false });
      const arr = [];
      ["éŒ¢åŒ…","é‘°åŒ™","è­·ç…§","èº«åˆ†è­‰å½±æœ¬","é£¯åº—è¨‚è³¼è³‡è¨Šå½±æœ¬","è€³æ©Ÿ","S24U/éš¨èº«ç¢Ÿ/ç¡¬ç¢Ÿ","å¹³æ¿","è¡›ç”Ÿç´™","å¡‘è† è¢‹","å‚˜","è¬ç”¨æ’é ­/å……é›»ç·š","è¡Œå‹•é›»æº(è¨˜å¾—WHæ¨™ç¤º)","è¡›ç”Ÿæ£‰","çœ¼é¡/ç›’å­/éš±å½¢æ—¥æ‹‹","é€æ˜å¤¾éˆè¢‹","æ‰‹æ©Ÿæ›ç¹©","é…’ç²¾æ¿•ç´™å·¾","è¡Œæè¢‹"]
        .forEach(x=>arr.push(add("å¿…éœ€å“", x)));
      ["OKè¹¦","é˜²æ›¬","å£ç½©","éæ•è—¥"].forEach(x=>arr.push(add("è—¥å“", x)));
      ["ç‰™è†ç‰™åˆ·","æ´—é¢ä¹³","å¸å¦","ä¹³æ¶²","é›¢å­å¤¾","æ¢³å­","é«®å¤¾é«®åœˆé«®å¸¶","æµ´å·¾(æ‹‹æ£„å¼)","åŒ–å¦åŒ…"]
        .forEach(x=>arr.push(add("æ´—æ¼±ç”¨å“", x)));
      ["è¡£æœ","è¤²å­","ç¡è¡£","å¤–å¥—","è¥ªå­","å…§è¡£å…§è¤²","é£¾å“"].forEach(x=>arr.push(add("è¡£ç‰©", x)));
      ["æ‰‹ç‡ˆ/è²“è€³/è£é£¾/é›»æ± ","å¨ƒå¨ƒ","å¡/å¡å¥—/å¡ç›’/å¡è†œ","æœƒå“¡å¡"].forEach(x=>arr.push(add("è¿½æ˜Ÿ", x)));
      return arr;
    },
    luggageCategories(){
      const set = new Set((this.activeTrip?.luggage||[]).map(i=>i.category||"æœªåˆ†é¡"));
      return Array.from(set);
    },
    luggageItems(cat){
      return (this.activeTrip.luggage||[]).filter(i=>(i.category||"æœªåˆ†é¡")===cat);
    },
    openAddLuggage(){
      this.editor = { open:true, type:"luggage", title:"â• æ–°å¢è¡Œæ", mode:"new", refId:"", data:{ category:"å¿…éœ€å“", name:"", note:"" } };
    },
    removeLuggage(id){
      this.activeTrip.luggage = this.activeTrip.luggage.filter(i=>i.id!==id);
      this.persist();
    },
switchDay(d){
  d = String(d);
  if(d === String(this.activeDay)) return;

  // å…ˆæŠŠèˆŠçš„ sortable é—œæ‰ï¼ˆé¿å…è§¸æ§åƒé»ï¼‰
  const oldEl = document.getElementById("planList-"+this.activeDay);
  if(oldEl && oldEl.__sortableInstance){
    oldEl.__sortableInstance.destroy();
    oldEl.__sortableInstance = null;
  }

  // âœ… ç«‹åˆ»æ›æ—¥ï¼ˆé€™ä¸€è¡Œå°±æ˜¯æ±ºå®šã€Œæ·±è‰²ã€çš„ï¼‰
  this.activeDay = d;

  // âœ… DOM æ›´æ–°å¾Œå† mount sortable
  this.$nextTick(()=> this.mountSortable());
},
// æ‰¾å‡ºæŸå€‹è¡Œç¨‹ item ç›®å‰åœ¨å“ªå€‹ bucketï¼ˆYYYY-MM-DD æˆ– _unscheduledï¼‰
findPlanBucketById(itemId){
  const itin = this.activeTrip?.itinerary || {};
  for(const k of Object.keys(itin)){
    const arr = itin[k] || [];
    if(arr.some(x => x.id === itemId)) return k;
  }
  return null;
},

// å¾ bucket ç§»é™¤ä¸¦å›å‚³è©² itemï¼ˆæ‰¾ä¸åˆ°å› nullï¼‰
pullPlanItemFromBucket(bucketKey, itemId){
  const arr = this.activeTrip.itinerary[bucketKey] || [];
  const idx = arr.findIndex(x => x.id === itemId);
  if(idx < 0) return null;
  return arr.splice(idx, 1)[0];
},

// âœ… å¾…æ”¾å€ä¸‹æ‹‰ã€ŒæŒ‡æ´¾æ—¥æœŸã€ï¼šçœŸçš„æŠŠ item å¾ _unscheduled æ¬åˆ° í•´ë‹¹æ—¥æœŸï¼ˆæˆ–åå‘ï¼‰
assignPlanDate(item, dateStr){
  if(!this.activeTrip) return;

  const toKey = (dateStr && String(dateStr).trim()) ? String(dateStr) : "_unscheduled";
  const fromKey = this.findPlanBucketById(item.id);

  if(!fromKey || fromKey === toKey) return;

  // 1) å¾åŸæœ¬ bucket æ‹¿å‡º
  const moved = this.pullPlanItemFromBucket(fromKey, item.id);
  if(!moved) return;

  // 2) å¯«å› item.dateï¼ˆè®“ä¹‹å¾Œç·¨è¼¯ä¹ŸçŸ¥é“å®ƒå±¬æ–¼å“ªå¤©ï¼‰
  moved.date = (toKey === "_unscheduled") ? "" : toKey;

  // 3) å¡é€²ç›®æ¨™ bucket
  this.activeTrip.itinerary[toKey] ||= [];
  this.activeTrip.itinerary[toKey].push(moved);

  this.persist();

  // 4) å¦‚æœæ¬åˆ°ç›®å‰ activeDayï¼Œé‡æ–°æ› sortableï¼ˆé¿å…æ‹–æ›³å£æ‰ï¼‰
  this.$nextTick(()=> this.mountSortable());
},

    // ---------- plan ----------
    mountSortable(){
      if(!this.activeTrip || !this.activeDay) return;
      const el = document.getElementById("planList-"+this.activeDay);
      if(!el) return;

      // é‡æ–° mountï¼ˆé¿å…åˆ‡æ—¥å¾Œä¸èƒ½æ‹–ï¼‰
      if(el.__sortableInstance){
        el.__sortableInstance.destroy();
        el.__sortableInstance = null;
      }

      el.__sortableInstance = Sortable.create(el, {
        animation: 180,
        delay: 200,
        delayOnTouchOnly: true,
        ghostClass: "opacity-60",
        onEnd: (evt)=>{
          const list = this.activeTrip.itinerary[this.activeDay] || [];
          const moved = list.splice(evt.oldIndex, 1)[0];
          list.splice(evt.newIndex, 0, moved);
          this.persist();
        }
      });
    },
    syncDaysAfterTripEdit(){
      if(!this.activeTrip) return;
      const keep = this.activeTrip.itinerary || {};
const next = { _unscheduled: keep._unscheduled || [] };

for(const d of this.tripDays(this.activeTrip)){
  next[d] = keep[d] || [];
}

this.activeTrip.itinerary = next;
      this.activeDay = this.tripDays(this.activeTrip)[0] || "";
      this.persist();
      this.$nextTick(()=> this.mountSortable());
    },
    openAddPlanItem(){
  this.editor = {
    open:true, type:"plan", title:"â• æ–°å¢è¡Œç¨‹", mode:"new", refId:"",
    data:{
      id: this.uid(),
      date: (this.activeDay==="_unscheduled" ? "" : (this.activeDay||"")),
      time: "",
      category: "",
      title: "",
      place: "",
      map: "",
      link: "",
      note: "",
      images: []
    }
  };
},
    editPlanItem(item){
      this.editor = {
        open:true, type:"plan", title:"âœï¸ ç·¨è¼¯è¡Œç¨‹", mode:"edit", refId:item.id,
        data: JSON.parse(JSON.stringify(item))
      };
    },
    removePlanItem(id){
      if(!confirm("åˆªé™¤æ­¤è¡Œç¨‹é …ç›®ï¼Ÿ")) return;
      this.activeTrip.itinerary[this.activeDay] = (this.activeTrip.itinerary[this.activeDay]||[]).filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- notes ----------
    openAddNote(){
      this.editor = {
        open:true, type:"note", title:"â• æ–°å¢å‚™å¿˜", mode:"new", refId:"",
        data:{ id:this.uid(), date:"", time:"", title:"", place:"", map:"", link:"", note:"", images:[] }
      };
    },
    editNote(n){
      this.editor = {
        open:true, type:"note", title:"âœï¸ ç·¨è¼¯å‚™å¿˜", mode:"edit", refId:n.id,
        data: JSON.parse(JSON.stringify(n))
      };
    },
    removeNote(id){
      if(!confirm("åˆªé™¤æ­¤å‚™å¿˜ï¼Ÿ")) return;
      this.activeTrip.notes = this.activeTrip.notes.filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- expenses ----------
    totalExpenseTWD(){
      return (this.activeTrip.expenses||[]).reduce((s,e)=>s+(Number(e.amountTWD)||0),0);
    },
    dayTotalTWD(d){
      if(!d) return this.totalExpenseTWD();
      return (this.activeTrip.expenses||[]).filter(e=>e.date===d).reduce((s,e)=>s+(Number(e.amountTWD)||0),0);
    },
    filteredExpenses(){
      const list = (this.activeTrip.expenses||[]).slice().sort((a,b)=>(a.date>b.date?-1:1));
      if(!this.selectedExpenseDay) return list;
      return list.filter(e=>e.date===this.selectedExpenseDay);
    },
    calcExpenseTWD(e){
      const c = this.activeTrip.currencies.find(x=>x.code===e.currency) || { rateToTWD:1 };
      return Number(e.amount||0) * Number(c.rateToTWD||1);
    },

    hasCustomSplit(e){
      const sc = e.splitCustom || {};
      return Object.keys(sc).some(k => Number(sc[k]) > 0);
    },

    openAddExpense(){
      const defaultDate = this.activeDay || this.tripDays(this.activeTrip)[0] || dayjs().format("YYYY-MM-DD");
      this.editor = {
        open:true, type:"expense", title:"â• æ–°å¢è¨˜å¸³", mode:"new", refId:"",
        data:{
          id:this.uid(),
          date: defaultDate,
          category:"é¤é£²",
          title:"",
          place:"",
          currency:"KRW",
          amount: 0,
          amountTWD: 0,
          method:"ç¾é‡‘",
          paidBy: (this.activeTrip.people[0]?.id || ""),
          splitAmong: (this.activeTrip.people.map(p=>p.id)),
          splitCustom: {},   // âœ…
          note:"",
          receipt:""
        }
      };
    },
    editExpense(e){
      const copy = JSON.parse(JSON.stringify(e));
      copy.splitCustom ||= {}; // âœ…
      this.editor = {
        open:true, type:"expense", title:"âœï¸ ç·¨è¼¯è¨˜å¸³", mode:"edit", refId:e.id,
        data: copy
      };
    },
    removeExpense(id){
      if(!confirm("åˆªé™¤æ­¤ç­†è¨˜å¸³ï¼Ÿ")) return;
      this.activeTrip.expenses = this.activeTrip.expenses.filter(x=>x.id!==id);
      this.persist();
    },

    // âœ… ä¾ã€Œè‡ªè¨‚åˆ†æ”¤ã€è¨ˆç®—æ¯å€‹äººçš„å¯¦éš›åˆ†æ”¤ï¼ˆå°å¹£ï¼‰
    getExpenseShares(e){
      const amt = Number(e.amountTWD || 0);
      const people = new Set((this.activeTrip.people||[]).map(p=>p.id));
      const split = (e.splitAmong||[]).filter(pid=>people.has(pid));
      const custom = e.splitCustom || {};

      const chosen = split.length ? split : (e.paidBy ? [e.paidBy] : []);
      let customSum = 0;
      const filled = [];
      const blank = [];

      for(const pid of chosen){
        const v = Number(custom[pid]);
        if(v > 0){
          filled.push({pid, v});
          customSum += v;
        }else{
          blank.push(pid);
        }
      }

      const remain = Math.max(0, amt - customSum);
      const each = blank.length ? (remain / blank.length) : 0;

      const out = [];
      for(const f of filled) out.push({ pid: f.pid, shareTWD: f.v });
      for(const pid of blank) out.push({ pid, shareTWD: each });

      return out;
    },

    previewSplitText(e){
      e.amountTWD = this.calcExpenseTWD(e);
      const shares = this.getExpenseShares(e);
      if(!shares.length) return "â€”";
      const a = shares[0];
      const b = shares.length>1 ? shares[1] : null;
      const more = shares.length>2 ? `â€¦ï¼ˆå…± ${shares.length} äººï¼‰` : "";
      const one = `${this.personName(a.pid)} NT$ ${this.money(a.shareTWD)}`;
      const two = b ? `ã€${this.personName(b.pid)} NT$ ${this.money(b.shareTWD)}` : "";
      return one + two + (more ? " " + more : "");
    },

    // âœ… å€‹äººç´¯ç©ï¼ˆä¾åˆ†æ”¤ï¼‰
    personTotals(){
      const people = this.activeTrip.people || [];
      const totals = {};
      for(const p of people) totals[p.id] = 0;

      for(const e of (this.activeTrip.expenses||[])){
        const shares = this.getExpenseShares(e);
        for(const s of shares){
          if(totals[s.pid] !== undefined) totals[s.pid] += Number(s.shareTWD||0);
        }
      }

      return people.map(p=>({
        pid: p.id,
        name: p.name,
        avatar: p.avatar,
        total: Math.round(totals[p.id] || 0)
      })).sort((a,b)=>b.total-a.total);
    },

    // settlement
    personName(pid){
      return this.activeTrip.people.find(p=>p.id===pid)?.name || "ï¼ˆæœªçŸ¥ï¼‰";
    },
    settlementLines(){
      const people = this.activeTrip.people.map(p=>p.id);
      const balance = {};
      for(const pid of people) balance[pid]=0;

      for(const e of (this.activeTrip.expenses||[])){
        const amt = Number(e.amountTWD||0);
        const payer = e.paidBy;
        if(balance[payer]===undefined) balance[payer]=0;
        balance[payer] += amt;

        const shares = this.getExpenseShares(e);
        for(const s of shares){
          if(balance[s.pid]===undefined) balance[s.pid]=0;
          balance[s.pid] -= Number(s.shareTWD||0);
        }
      }

      const creditors = [];
      const debtors = [];
      for(const pid of people){
        const v = Math.round(balance[pid]);
        if(v>0) creditors.push({pid, v});
        else if(v<0) debtors.push({pid, v: -v});
      }
      creditors.sort((a,b)=>b.v-a.v);
      debtors.sort((a,b)=>b.v-a.v);

      const lines=[];
      let i=0,j=0;
      while(i<debtors.length && j<creditors.length){
        const d = debtors[i], c = creditors[j];
        const pay = Math.min(d.v, c.v);
        if(pay>0){
          // âœ… é€™è£¡æ”¹æˆæ›´ä¹¾æ·¨çš„ç®­é ­ï¼Œä¸ç”¨ã€Œèª°æ¬ èª°ã€å­—æ¨£
          lines.push(`${this.personName(d.pid)} â†’ ${this.personName(c.pid)}  NT$ ${this.money(pay)}`);
          d.v -= pay;
          c.v -= pay;
        }
        if(d.v===0) i++;
        if(c.v===0) j++;
      }
      return lines;
    },

    // ---------- currencies ----------
    addCurrency(){
      const code = (this.newCur.code||"").trim().toUpperCase();
      if(!code) return alert("è«‹è¼¸å…¥å¹£åˆ¥ä»£ç¢¼ï¼ˆä¾‹å¦‚ JPYï¼‰");
      if(this.activeTrip.currencies.some(c=>c.code===code)) return alert("å·²å­˜åœ¨æ­¤å¹£åˆ¥");
      const rate = Number(this.newCur.rateToTWD||0);
      if(!rate || rate<=0) return alert("è«‹è¼¸å…¥æ­£ç¢ºåŒ¯ç‡");
      this.activeTrip.currencies.push({ code, name:(this.newCur.name||""), rateToTWD: rate });
      this.newCur = { code:"", name:"", rateToTWD: 1 };
      this.persist();
    },
    removeCurrency(code){
      if(!confirm("åˆªé™¤å¹£åˆ¥ï¼Ÿ")) return;
      this.activeTrip.currencies = this.activeTrip.currencies.filter(c=>c.code!==code);
      this.persist();
    },
openRateLink(){
  window.open(
    "https://www.msn.com/zh-tw/money/tools/currencyconverter?ocid=winp2fpent&bundles=staging&id=avff1h",
    "_blank",
    "noopener"
  );
},
    // âœ… è‡ªå‹•æ›´æ–°åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•æ”¹ï¼‰
    async autoUpdateRates(){
  try{
    // å–å‡ºç›®å‰ä½ æœ‰ç”¨åˆ°çš„å¹£åˆ¥ä»£ç¢¼ï¼ˆæ’é™¤ TWDï¼‰
    const codes = (this.activeTrip.currencies || [])
      .map(c => c.code)
      .filter(code => code && code !== "TWD");

    // Frankfurterï¼šç”¨ USD ç•¶åŸºæº–ï¼Œä¸€æ¬¡æŠ“ USD->TWD å’Œ USD->å…¶ä»–å¹£
    const symbols = ["TWD", ...codes].join(",");

    const res = await fetch(`https://api.frankfurter.dev/v1/latest?base=USD&symbols=${encodeURIComponent(symbols)}`);
    const js = await res.json();
    const r = js.rates || {};

    if(!r.TWD) throw new Error("No TWD rate from API");

    const usdToTwd = Number(r.TWD);

    const missing = [];

    for(const c of this.activeTrip.currencies){
      if(c.code === "TWD"){ c.rateToTWD = 1; continue; }

      const usdToCur = Number(r[c.code]);
      if(!usdToCur){
        missing.push(c.code);
        continue; // é€™å€‹å¹£åˆ¥ API æ²’æä¾›ï¼Œå°±ä¿ç•™ä½ æ‰‹å‹•è¼¸å…¥çš„åŒ¯ç‡
      }

      // ä½ è¦çš„æ˜¯ï¼š1 å–®ä½å¤–å¹£ = å¤šå°‘ TWD
      // è‹¥ 1 USD = usdToCur CUR ä¸” 1 USD = usdToTwd TWD
      // å‰‡ 1 CUR = usdToTwd / usdToCur TWD
      c.rateToTWD = Number((usdToTwd / usdToCur).toFixed(6));
    }

    this.persist();

    if(missing.length){
      alert(`å·²æ›´æ–°åŒ¯ç‡ï¼Œä½†ä»¥ä¸‹å¹£åˆ¥ API æ²’æä¾›ï¼Œä¿ç•™åŸæœ¬æ‰‹å‹•å€¼ï¼š${missing.join(", ")}`);
    }else{
      alert("å·²æ›´æ–°åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•èª¿æ•´ï¼‰");
    }

  }catch(e){
    alert("è‡ªå‹•æ›´æ–°åŒ¯ç‡å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯/CORS/API æœå‹™ç•°å¸¸ï¼‰ã€‚ä½ å¯ä»¥å…ˆæ‰‹å‹•è¼¸å…¥ã€‚");
    console.error(e);
  }
},

    // ---------- fav ----------
    openAddFav(){
      this.editor = {
        open:true, type:"fav", title:"â• æ–°å¢æ”¶è—", mode:"new", refId:"",
        data:{ id:this.uid(), category:"", area:"æœªåˆ†é¡åœ°å€", name:"", price:null, currency:"KRW", qty:1, place:"", buyer:"", links:[], image:"", note:"" }
      };
    },
  editFav(it){
  // 1ï¸âƒ£å…ˆè¤‡è£½ä¸€ä»½è³‡æ–™ï¼ˆé¿å…ç›´æ¥æ”¹åˆ°åŸè³‡æ–™ï¼‰
  const copy = JSON.parse(JSON.stringify(it));

  // 2ï¸âƒ£ å¦‚æœæ²’æœ‰ linksï¼Œå°±å…ˆè£œä¸€å€‹ç©ºé™£åˆ—
  if(!Array.isArray(copy.links)){
    copy.links = [];
  }

  // 3ï¸âƒ£å¦‚æœæ˜¯èˆŠè³‡æ–™ï¼ˆåªæœ‰ linkï¼Œæ²’æœ‰ linksï¼‰
  if(copy.link && typeof copy.link === "string"){
    const oldUrl = copy.link.trim();

    // æœ‰èˆŠç¶²å€æ‰è½‰
    if(oldUrl){
      copy.links.push({
        label: "",     // åç¨±å…ˆç©ºç™½
        url: oldUrl    // èˆŠç¶²å€æ”¾é€²ä¾†
      });
    }

    // 4ï¸âƒ£ åˆªæ‰èˆŠæ¬„ä½ï¼Œé¿å…ä¹‹å¾Œæ··äº‚
    delete copy.link;
  }

  // 5ï¸âƒ£ æ‰“é–‹ç·¨è¼¯è¦–çª—
  this.editor = {
    open:true,
    type:"fav",
    title:"âœï¸ ç·¨è¼¯æ”¶è—",
    mode:"edit",
    refId: it.id,
    data: copy
  };
},


    removeFav(id){
      if(!confirm("åˆªé™¤æ­¤æ”¶è—ï¼Ÿ")) return;
      this.activeTrip.fav = this.activeTrip.fav.filter(x=>x.id!==id);
      this.persist();
    },
    filteredFav(){
      const list = (this.activeTrip.fav||[]).slice();
      if(!this.favFilter) return list;
      return list.filter(x=>x.category===this.favFilter);
    },
    favGroupedByArea(){
      const list = this.filteredFav();
      const map = new Map();
      for(const it of list){
        const area = (it.area||"æœªåˆ†é¡åœ°å€").trim() || "æœªåˆ†é¡åœ°å€";
        if(!map.has(area)) map.set(area, []);
        map.get(area).push(it);
      }
      const groups = Array.from(map.entries()).map(([area,items])=>({
        area,
        items: items.sort((a,b)=>(a.category||"").localeCompare(b.category||""))
      }));
      groups.sort((a,b)=>{
        if(a.area==="æœªåˆ†é¡åœ°å€") return 1;
        if(b.area==="æœªåˆ†é¡åœ°å€") return -1;
        return a.area.localeCompare(b.area);
      });
      return groups;
    },
    addFavCategory(){
      const c = (this.newFavCategory||"").trim();
      if(!c) return;
      if(this.activeTrip.favCategories.includes(c)) return alert("å·²å­˜åœ¨æ­¤é¡å‹");
      this.activeTrip.favCategories.push(c);
      this.newFavCategory="";
      this.persist();
    },
    removeFavCategory(c){
      if(!confirm("åˆªé™¤æ­¤é¡å‹ï¼Ÿï¼ˆä¸æœƒåˆªé™¤å·²å­˜åœ¨çš„æ”¶è—é …ç›®ï¼Œåªæ˜¯ä¸å†å‡ºç¾åœ¨é¸å–®ï¼‰")) return;
      this.activeTrip.favCategories = this.activeTrip.favCategories.filter(x=>x!==c);
      if(this.favFilter===c) this.favFilter="";
      this.persist();
    },

    // ---------- shop ----------
    openAddShop(){
      this.editor = {
        open:true, type:"shop", title:"â• æ–°å¢ä»£è³¼/è³¼ç‰©", mode:"new", refId:"",
        data:{ id:this.uid(), area:"æœªåˆ†é¡åœ°å€", name:"", price:null, currency:"KRW", qty:1, place:"", buyer:"", link:"", image:"", note:"" }
      };
    },
    editShop(it){
      this.editor = { open:true, type:"shop", title:"âœï¸ ç·¨è¼¯ä»£è³¼/è³¼ç‰©", mode:"edit", refId:it.id, data: JSON.parse(JSON.stringify(it)) };
    },
    removeShop(id){
      if(!confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
      this.activeTrip.shop = this.activeTrip.shop.filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- flights ----------
    startAddFlight(){
      this.activeTrip.flights ||= [];
      this.editor = {
        open:true, type:"flight", title:"â• æ–°å¢èˆªç­", mode:"new", refId:"",
        data:{ id:this.uid(), type:"å»ç¨‹", date:"", depAirport:"", arrAirport:"", depTime:"", arrTime:"", flightNo:"", note:"" }
      };
    },
    editFlight(f){
      this.editor = { open:true, type:"flight", title:"âœï¸ ç·¨è¼¯èˆªç­", mode:"edit", refId:f.id, data: JSON.parse(JSON.stringify(f)) };
    },
    removeFlight(id){
      if(!confirm("åˆªé™¤æ­¤èˆªç­ï¼Ÿ")) return;
      this.activeTrip.flights = (this.activeTrip.flights||[]).filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- editor save/close ----------
    closeEditor(){
  this.editor = { open:false, type:"", title:"", data:{}, mode:"new", refId:"" };
},
    saveEditor(){
      const t = this.editor.type;
      const data = this.editor.data;

      if(t==="person"){
        if(!data.name || !data.name.trim()) return alert("åå­—å¿…å¡«");
        if(this.editor.mode==="new"){
          this.activeTrip.people.push({ id:this.uid(), name:data.name.trim(), avatar: data.avatar||"" });
        }else{
          const p = this.activeTrip.people.find(x=>x.id===this.editor.refId);
          if(p){ p.name=data.name.trim(); p.avatar=data.avatar||""; }
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="flight"){
        this.activeTrip.flights ||= [];
        if(this.editor.mode==="new"){
          this.activeTrip.flights.unshift(data);
        }else{
          const idx = this.activeTrip.flights.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.flights[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }
if(t==="infoBlock"){
  if(!data.title || !data.title.trim()){
    return alert("è«‹å¡«å¯«è³‡è¨Šæ¨™é¡Œ");
  }

  this.activeTrip.infoBlocks ||= [];

  if(this.editor.mode==="new"){
    this.activeTrip.infoBlocks.unshift({
      id: data.id || this.uid(),
      key: data.key || "",
      title: data.title.trim(),
      content: data.content || "",
      link: data.link || "",
      hint: data.hint || ""
    });
  }else{
    const idx = this.activeTrip.infoBlocks.findIndex(x=>x.id===this.editor.refId);
    if(idx >= 0){
      this.activeTrip.infoBlocks[idx] = {
        ...this.activeTrip.infoBlocks[idx],
        title: data.title.trim(),
        content: data.content || "",
        link: data.link || "",
        hint: data.hint || ""
      };
    }
  }

  this.persist();
  this.closeEditor();
  return;
}

      if(t==="luggage"){
        if(!data.name || !data.name.trim()) return alert("é …ç›®åç¨±å¿…å¡«");
        this.activeTrip.luggage.push({ id:this.uid(), category:(data.category||"æœªåˆ†é¡"), name:data.name.trim(), note:data.note||"", done:false });
        this.persist(); this.closeEditor(); return;
      }

     if(t==="plan"){
  if(this.editor.mode==="new"){
    const targetDate = data.date || "_unscheduled";
    this.activeTrip.itinerary[targetDate] ||= [];
    this.activeTrip.itinerary[targetDate].push(data);
  }else{
    // âœ… ç·¨è¼¯æ™‚å…è¨±æ”¹æ—¥æœŸï¼šè·¨æ—¥æ¬ç§»
    const toKey = (data.date && String(data.date).trim()) ? String(data.date) : "_unscheduled";
    const fromKey = this.findPlanBucketById(this.editor.refId);

    if(!fromKey){
      this.activeTrip.itinerary[toKey] ||= [];
      this.activeTrip.itinerary[toKey].push(data);
    }else if(fromKey === toKey){
      const arr = this.activeTrip.itinerary[fromKey] || [];
      const idx = arr.findIndex(x=>x.id===this.editor.refId);
      if(idx>=0) arr[idx] = data;
    }else{
      const moved = this.pullPlanItemFromBucket(fromKey, this.editor.refId) || data;
      moved.date = (toKey === "_unscheduled") ? "" : toKey;
      Object.assign(moved, data);

      this.activeTrip.itinerary[toKey] ||= [];
      this.activeTrip.itinerary[toKey].push(moved);
    }
  }

  this.persist();
  this.closeEditor();
  this.$nextTick(()=> this.mountSortable());
  return;
}
      if(t==="note"){
        if(this.editor.mode==="new"){
          this.activeTrip.notes.unshift(data);
        }else{
          const idx = this.activeTrip.notes.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.notes[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="expense"){
        data.amountTWD = this.calcExpenseTWD(data);
        data.splitCustom ||= {};
        if(!data.date) return alert("è«‹å¡«æ—¥æœŸï¼ˆè¨˜å¸³éœ€è¦æ—¥æœŸï¼‰");
        if(!data.splitAmong || data.splitAmong.length===0) return alert("è‡³å°‘é¸ 1 ä½åˆ†æ”¤äººå“¡");
        if(this.editor.mode==="new"){
          this.activeTrip.expenses.unshift(data);
        }else{
          const idx = this.activeTrip.expenses.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.expenses[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="fav"){
data.links = (data.links||[])
  .map(x=>({ label:(x.label||""), url:(x.url||"").trim() }))
  .filter(x=>x.url);
        if(this.editor.mode==="new"){
          this.activeTrip.fav.unshift(data);
        }else{
          const idx = this.activeTrip.fav.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.fav[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="shop"){
        if(this.editor.mode==="new"){
          this.activeTrip.shop.unshift(data);
        }else{
          const idx = this.activeTrip.shop.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.shop[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }
    },

    // ---------- image pick ----------
    readFileAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    },
    async onAddImagesToEditor(ev){
      const files = Array.from(ev.target.files||[]);
      if(!files.length) return;
      this.editor.data.images ||= [];
      for(const f of files){
        const url = await this.readFileAsDataURL(f);
        this.editor.data.images.push(url);
      }
      ev.target.value="";
    },
    async onPickSingleImageToEditor(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      this.editor.data.image = await this.readFileAsDataURL(f);
      ev.target.value="";
    },
    async onPickReceipt(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      this.editor.data.receipt = await this.readFileAsDataURL(f);
      ev.target.value="";
    },

    // ---------- people ----------
    startAddPerson(){
      this.editor = { open:true, type:"person", title:"â• æ–°å¢äººå“¡", mode:"new", refId:"", data:{ name:"", avatar:"" } };
    },
    editPerson(p){
      this.editor = { open:true, type:"person", title:"âœï¸ ç·¨è¼¯äººå“¡", mode:"edit", refId:p.id, data: JSON.parse(JSON.stringify(p)) };
    },
    removePerson(id){
      if(!confirm("åˆªé™¤æ­¤äººå“¡ï¼Ÿï¼ˆå·²è¨˜å¸³è³‡æ–™ä»æœƒä¿ç•™æ”¯ä»˜è€… idï¼Œå»ºè­°å…ˆæ”¹è¨˜å¸³ï¼‰")) return;
      this.activeTrip.people = this.activeTrip.people.filter(p=>p.id!==id);
      this.persist();
    },

    // ---------- avatar crop ----------
    async onPickTripAvatar(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      const src = await this.readFileAsDataURL(f);
      this.openCropper(src, (cropped)=>{
        this.activeTrip.avatar = cropped;
        this.persist();
      });
      ev.target.value="";
    },
    async onPickPersonAvatar(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      const src = await this.readFileAsDataURL(f);
      this.openCropper(src, (cropped)=>{
        this.editor.data.avatar = cropped; // immediate preview
      });
      ev.target.value="";
    },
    openCropper(src, cb){
      this.crop.open = true;
      this.crop.imgSrc = src;
      this.crop.scale = 1.4;
      this.crop.offX = 0;
      this.crop.offY = 0;
      this.crop.dragging = false;
      this.crop.callback = cb;
    },
    cropImgStyle(){
      const s = this.crop.scale;
      return {
        transform: `translate(calc(-50% + ${this.crop.offX}px), calc(-50% + ${this.crop.offY}px)) scale(${s})`,
        transformOrigin: "center",
        width: "100%",
        height: "100%",
        objectFit: "cover"
      };
    },
    cropPointerDown(e){
      this.crop.dragging = true;
      this.crop.px = e.clientX;
      this.crop.py = e.clientY;
      e.target.setPointerCapture?.(e.pointerId);
    },
    cropPointerMove(e){
      if(!this.crop.dragging) return;
      const dx = e.clientX - this.crop.px;
      const dy = e.clientY - this.crop.py;
      this.crop.px = e.clientX;
      this.crop.py = e.clientY;
      this.crop.offX += dx;
      this.crop.offY += dy;
    },
    cropPointerUp(){ this.crop.dragging = false; },
    closeCropper(use){
      if(!use){
        this.crop.open=false;
        return;
      }
      const size = 512;
      const canvas = document.createElement("canvas");
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext("2d");

      const img = new Image();
      img.onload = ()=>{
        const iw = img.width, ih = img.height;
        const scaleCover = Math.max(size/iw, size/ih);
        const dw = iw*scaleCover, dh = ih*scaleCover;
        const dx0 = (size - dw)/2;
        const dy0 = (size - dh)/2;

        const s = this.crop.scale;
        const dx = this.crop.offX * (size / 460);
        const dy = this.crop.offY * (size / 460);

        ctx.save();
        ctx.translate(size/2 + dx, size/2 + dy);
        ctx.scale(s, s);
        ctx.translate(-size/2, -size/2);
        ctx.drawImage(img, dx0, dy0, dw, dh);
        ctx.restore();

        const out = canvas.toDataURL("image/jpeg", 0.92);
        this.crop.open=false;
        if(typeof this.crop.callback==="function") this.crop.callback(out);
      };
      img.src = this.crop.imgSrc;
    },

    // ---------- weather (Open-Meteo) ----------
    async searchCity(){
      const q = (this.weatherQuery||"").trim();
      if(!q) return;
      this.weatherStatus = "æœå°‹åŸå¸‚ä¸­â€¦";
      try{
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=zh&format=json`;
        const res = await fetch(url);
        const js = await res.json();
        if(!js.results || !js.results.length){
          this.weatherStatus = "æ‰¾ä¸åˆ°åŸå¸‚ï¼Œè©¦è©¦è‹±æ–‡æ‹¼éŸ³ï¼ˆSeoul / Tokyoï¼‰";
          return;
        }
        const r = js.results[0];
        this.weather.cityName = `${r.name}${r.country ? " Â· "+r.country : ""}`;
        await this.fetchWeather(r.latitude, r.longitude);
        this.weatherStatus = "";
        this.activeTrip.city = q;
        this.persist();
      }catch(e){
        this.weatherStatus = "å¤©æ°£æœå‹™æš«æ™‚å¤±æ•—ï¼ˆè«‹ç¨å¾Œå†è©¦ï¼‰";
      }
    },
    async refreshWeather(){
      const q = (this.activeTrip?.city || this.weatherQuery || "Seoul").trim();
      this.weatherQuery = q;
      await this.searchCity();
    },
    async fetchWeather(lat, lon){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,windspeed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
      const res = await fetch(url);
      const js = await res.json();
      this.weather.updatedAt = dayjs().format("YYYY/MM/DD HH:mm");
      this.weather.current = {
        temperature: Math.round(js.current.temperature_2m),
        windspeed: Math.round(js.current.windspeed_10m)
      };
      const days = js.daily.time.map((t,idx)=>({
        date: t,
        weekday: this.dow(t),
        tmax: Math.round(js.daily.temperature_2m_max[idx]),
        tmin: Math.round(js.daily.temperature_2m_min[idx])
      }));
      this.weather.daily = days;
    }
  }
}).mount("#app");
</script>
</body>
</html>
