<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TripBook - ITZY Seoul 2026</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: "#0f172a",
            soft: "#f8fafc",
            card: "rgba(255,255,255,0.92)",
            baby: "#9ec5ff",
            baby2: "#cfe3ff",
            bluegray: "#5b6b84",
            lavender: "#d8d0ff"
          },
          boxShadow: {
            soft: "0 10px 30px rgba(15, 23, 42, 0.08)",
            insetSoft: "inset 0 1px 0 rgba(255,255,255,.55)"
          }
        }
      }
    }
  </script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- SortableJS (drag reorder with delay) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <!-- å­—é«”ï¼šå…ˆç”¨ Noto Sans TCï¼ˆä½ è¦æºæ³‰åœ“é«”æˆ‘ä¸‹é¢æœ‰ä¿ç•™ GenSenRoundedTW çš„ font-family åç¨±ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* æ›´è—ç°ã€å°‘ç™½ä¸€é» */
      --bg1:#eef3fb;
      --bg2:#dee8f8;
      --line: rgba(91,107,132,.22);
      --ring: rgba(158,197,255,.45);
    }
    html,body{ height:100%; }
    body{
      font-family: "GenSenRoundedTW", "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, var(--bg2), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(216,208,255,.45), transparent 55%),
                  linear-gradient(180deg, var(--bg1), #f7faff);
      color:#0f172a;
    }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 84px); }
    .glass { background: rgba(225,235,250,0.78); backdrop-filter: blur(10px); }
    .chip { border: 1px solid var(--line); background: rgba(255,255,255,.72); }
    .btn { border: 1px solid var(--line); }
    .btnPrimary { background: linear-gradient(180deg, rgba(158,197,255,.95), rgba(158,197,255,.65)); }
    .btnPrimary:hover{ filter: brightness(0.98); }
    .input {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.82);
      outline: none;
    }
    .input:focus{ box-shadow: 0 0 0 4px var(--ring); }
    .segActive{
      background: linear-gradient(180deg, rgba(207,227,255,.95), rgba(207,227,255,.65));
      border-color: rgba(158,197,255,.55);
    }
    .hint { color: rgba(91,107,132,.9); }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body>
<div id="app" class="min-h-screen">
  <!-- Top -->
  <header class="sticky top-0 z-40">
    <div class="glass border-b" style="border-color: var(--line);">
      <div class="max-w-[460px] mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl shadow-soft overflow-hidden bg-white border" style="border-color: var(--line);">
            <img v-if="activeTrip?.avatar" :src="activeTrip.avatar" class="w-full h-full object-cover" alt="">
            <div v-else class="w-full h-full grid place-items-center text-bluegray">ğŸ§³</div>
          </div>
          <div>
            <div class="text-[13px] hint">{{ nowText }}</div>
            <div class="font-bold tracking-tight text-[15px]">
              {{ activeTrip ? activeTrip.title : "æˆ‘çš„è¡Œç¨‹ç›®éŒ„" }}
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- âœ… ç›´æ¥å›ç›®éŒ„ï¼ˆä¸ç”¨é€²è¨­å®šï¼‰ -->
          <button v-if="activeTrip"
                  class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="backToCatalog()">
            ğŸ  å›ç›®éŒ„
          </button>
          <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="openTripCatalog=true">
            ğŸ“š ç›®éŒ„
          </button>
          <button v-if="activeTrip" class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white shadow-insetSoft"
                  @click="openTripSettings=true">
            âš™ï¸ è¨­å®š
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-[460px] mx-auto px-4 pt-4 safe-bottom">
    <!-- If no trip selected -> catalog -->
    <section v-if="!activeTrip">
      <div class="rounded-3xl p-4 bg-card shadow-soft border" style="border-color: var(--line);">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-[16px]">ğŸ“Œ é¸æ“‡è¡Œç¨‹</div>
            <div class="text-[13px] hint mt-1">é»å¡ç‰‡å°±ç›´æ¥é€²å…¥ï¼ˆä¸ç”¨å¦å¤–é–‹å•Ÿï¼‰</div>
          </div>
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                  @click="startCreateTrip()">
            â• æ–°å¢è¡Œç¨‹
          </button>
        </div>

        <div class="mt-4 grid gap-3">
          <button v-for="t in store.trips" :key="t.id"
                  class="text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                  style="border-color: var(--line);"
                  @click="selectTrip(t.id)">
            <div class="flex gap-3 items-center">
              <div class="w-12 h-12 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="t.avatar" :src="t.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-bold truncate">{{ t.title }}</div>
                <div class="text-[13px] hint mt-0.5">
                  ğŸ“… {{ t.startDate }} â†’ {{ t.endDate }} Â· ğŸ‘¥ {{ t.people.length }} äºº Â· ğŸ’± {{ t.currencies.length }} å¹£åˆ¥
                </div>
              </div>
              <div class="text-[20px]">â€º</div>
            </div>
          </button>

          <div v-if="store.trips.length===0" class="text-center py-10 hint">
            é‚„æ²’æœ‰è¡Œç¨‹ï½å…ˆæ–°å¢ä¸€å€‹å§ âœ¨
          </div>
        </div>
      </div>
    </section>

    <!-- Trip Home (Tabs) -->
    <section v-else>
      <!-- Countdown -->
      <div class="rounded-3xl p-4 bg-card shadow-soft border" style="border-color: var(--line);">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-bold text-[16px]">â³ é›¢å‡ºç™¼é‚„æœ‰</div>
            <div class="mt-1 text-[34px] font-extrabold tracking-tight mono">
              {{ daysUntil(activeTrip.startDate) }} å¤©
            </div>
            <div class="text-[13px] hint">ï¼ˆä»¥ {{ activeTrip.startDate }} ç‚ºå‡ºç™¼æ—¥ï¼‰</div>
          </div>
          <div class="text-right">
            <div class="text-[13px] hint">ğŸ“ é è¨­åŸå¸‚</div>
            <div class="font-semibold">{{ activeTrip.city || "Seoul" }}</div>
            <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white mt-2"
                    @click="tab='weather'">
              â˜ï¸ çœ‹å¤©æ°£
            </button>
          </div>
        </div>

        <!-- âœ… èˆªç­ï¼šä¸€é€²è¡Œç¨‹å°±çœ‹åˆ°ï¼ˆå¯ç”¨æ–¼å…¶ä»–æ—…è¡Œï¼‰ -->
        <div class="mt-4" v-if="(activeTrip.flights||[]).length">
          <div class="flex items-center justify-between">
            <div class="font-bold text-[16px]">âœˆï¸ èˆªç­</div>
            <button class="btn rounded-xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                    @click="openTripSettings=true">
              âš™ï¸ ç®¡ç†
            </button>
          </div>
          <div class="mt-2 grid gap-2">
            <div v-for="f in activeTrip.flights" :key="f.id"
                 class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                 style="border-color: var(--line);">
              <div class="text-[12px] hint">{{ f.type || "èˆªç­" }} Â· {{ f.date || "" }}</div>
              <div class="mt-1 font-bold">{{ f.depAirport || "â€”" }} â†’ {{ f.arrAirport || "â€”" }}</div>
              <div class="mt-1 text-[13px] hint mono">{{ f.depTime || "â€”" }} â†’ {{ f.arrTime || "â€”" }}</div>
              <div class="mt-1 text-[13px] hint" v-if="f.flightNo">èˆªç­ï¼š{{ f.flightNo }}</div>
              <div class="mt-1 text-[13px]" v-if="f.note">ğŸ“ {{ f.note }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-4 rounded-3xl p-2 bg-white/65 border shadow-soft sticky top-[72px] z-30"
           style="border-color: var(--line);">
        <div class="grid grid-cols-6 gap-2 text-[12px]">
          <button @click="tab='plan'" :class="segClass('plan')" class="rounded-2xl py-2 px-2 btn">
            ğŸ—“ï¸ è¡Œç¨‹
          </button>
          <button @click="tab='money'" :class="segClass('money')" class="rounded-2xl py-2 px-2 btn">
            ğŸ’¸ è¨˜å¸³
          </button>
          <button @click="tab='luggage'" :class="segClass('luggage')" class="rounded-2xl py-2 px-2 btn">
            ğŸ’ è¡Œæ
          </button>
          <button @click="tab='fav'" :class="segClass('fav')" class="rounded-2xl py-2 px-2 btn">
            â­ æ”¶è—
          </button>
          <button @click="tab='shop'" :class="segClass('shop')" class="rounded-2xl py-2 px-2 btn">
            ğŸ›ï¸ ä»£è³¼
          </button>
          <button @click="tab='info'" :class="segClass('info')" class="rounded-2xl py-2 px-2 btn">
            ğŸ“Œ è³‡è¨Š
          </button>
        </div>
      </div>

      <!-- Panels -->
      <div class="mt-4">
        <!-- è¡Œç¨‹ -->
        <section v-show="tab==='plan'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <!-- Day scroller -->
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between">
                <div class="font-bold text-[16px]">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹</div>
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="openAddPlanItem()">
                  â• æ–°å¢
                </button>
              </div>

              <div class="mt-3 flex gap-2 overflow-x-auto pb-2">
                <button v-for="d in tripDays(activeTrip)" :key="d"
                        @click="activeDay=d; $nextTick(()=>mountSortable())"
                        class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border shadow-insetSoft"
                        :class="activeDay===d ? 'segActive' : 'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);">
                  <div class="font-semibold">{{ md(d) }}</div>
                  <div class="text-[11px] hint">{{ dow(d) }}</div>
                </button>
              </div>
            </div>

            <!-- list -->
            <div class="p-4">
              <div class="text-[13px] hint">ğŸ‘† é•·æŒ‰ 0.2 ç§’å³å¯æ‹–æ›³æ’åºï¼ˆæ»‘å‹•è§€çœ‹æ²’å•é¡Œï¼‰</div>

              <div class="mt-3" v-if="(activeTrip.itinerary[activeDay]||[]).length===0">
                <div class="rounded-2xl p-4 border bg-white/65 text-center hint" style="border-color: var(--line);">
                  é€™å¤©é‚„æ²’å®‰æ’ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨
                </div>
              </div>

              <div class="mt-3 space-y-3" :id="'planList-'+activeDay">
                <div v-for="item in (activeTrip.itinerary[activeDay]||[])" :key="item.id"
                     class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                     style="border-color: var(--line);">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <div class="text-[12px] px-2 py-1 rounded-xl chip">
                          {{ item.time || "ï¼ˆæœªå¡«æ™‚é–“ï¼‰" }}
                        </div>
                        <div class="text-[12px] px-2 py-1 rounded-xl chip">
                          {{ item.category || "æœªåˆ†é¡" }}
                        </div>
                      </div>
                      <div class="mt-2 font-bold text-[16px] break-words">{{ item.title || "ï¼ˆæœªå¡«æ¨™é¡Œï¼‰" }}</div>
                      <div class="mt-1 text-[13px] hint break-words" v-if="item.place">ğŸ“ {{ item.place }}</div>
                      <div class="mt-2 text-[13px] break-words" v-if="item.note">ğŸ“ {{ item.note }}</div>

                      <div class="mt-2 flex flex-wrap gap-2" v-if="item.link || item.map">
                        <a v-if="item.link" :href="item.link" target="_blank"
                           class="text-[12px] underline decoration-baby/60">
                          ğŸ”— ç¶²å€
                        </a>
                        <a v-if="item.map" :href="item.map" target="_blank"
                           class="text-[12px] underline decoration-lavender/60">
                          ğŸ—ºï¸ åœ°åœ–
                        </a>
                      </div>

                      <div class="mt-3 grid grid-cols-3 gap-2" v-if="(item.images||[]).length">
                        <img v-for="(img,idx) in item.images" :key="idx" :src="img"
                             class="w-full aspect-square object-cover rounded-2xl border"
                             style="border-color: var(--line);" />
                      </div>
                    </div>

                    <div class="flex flex-col gap-2 shrink-0">
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="editPlanItem(item)">
                        âœï¸
                      </button>
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="removePlanItem(item.id)">
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- è¨˜å¸³ -->
        <section v-show="tab==='money'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="font-bold text-[16px]">ğŸ’¸ è¨˜å¸³</div>
                  <div class="text-[13px] hint mt-1">å¤šå¹£åˆ¥å¯æ–°å¢ï¼›æœ€å¾Œçµ±ä¸€æŠ˜ç®—å°å¹£</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                          @click="openCurrencyManager=true">
                    ğŸ’± åŒ¯ç‡
                  </button>
                  <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                          @click="openAddExpense()">
                    â• æ–°å¢
                  </button>
                </div>
              </div>

              <div class="mt-4 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="text-[13px] hint">ç¸½èŠ±è²»ï¼ˆæŠ˜å°å¹£ï¼‰</div>
                <div class="mt-1 text-[34px] font-extrabold mono">NT$ {{ money(totalExpenseTWD()) }}</div>
                <div class="mt-1 text-[13px] hint">
                  æœ¬æ—¥ï¼šNT$ {{ money(dayTotalTWD(selectedExpenseDay)) }} Â·
                  é¸æ—¥ï¼š{{ selectedExpenseDay || "å…¨éƒ¨" }}
                </div>
              </div>

              <!-- âœ… å€‹äººç´¯ç©ï¼ˆå«é ­åƒï¼‰ -->
              <div class="mt-4 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-[16px]">ğŸ‘¥ å€‹äººç´¯ç©</div>
                  <div class="text-[12px] hint">ä¾åˆ†æ”¤æŠ˜å°å¹£</div>
                </div>
                <div class="mt-3 grid gap-2">
                  <div v-for="p in personTotals()" :key="'pt-'+p.pid"
                       class="flex items-center gap-3 rounded-2xl p-3 border bg-white/70"
                       style="border-color: var(--line);">
                    <div class="w-10 h-10 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                      <img v-if="p.avatar" :src="p.avatar" class="w-full h-full object-cover" alt="">
                      <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold truncate">{{ p.name }}</div>
                      <div class="text-[12px] hint">å·²åˆ†æ”¤ï¼šNT$ {{ money(p.total) }}</div>
                    </div>
                    <div class="font-extrabold mono">NT$ {{ money(p.total) }}</div>
                  </div>
                </div>
              </div>

              <!-- day filter -->
              <div class="mt-3 flex items-center gap-2 overflow-x-auto pb-2">
                <button class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="selectedExpenseDay==='' ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="selectedExpenseDay=''">
                  å…¨éƒ¨
                </button>
                <button v-for="d in tripDays(activeTrip)" :key="'ed-'+d"
                        class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="selectedExpenseDay===d ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="selectedExpenseDay=d">
                  {{ md(d) }}
                </button>
              </div>
            </div>

            <!-- expense list -->
            <div class="p-4">
              <div v-if="filteredExpenses().length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                é‚„æ²’æœ‰è¨˜å¸³ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨
              </div>

              <div class="space-y-3">
                <div v-for="e in filteredExpenses()" :key="e.id"
                     class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                     style="border-color: var(--line);">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-[12px] hint mono">ğŸ“… {{ e.date }} Â· {{ e.category || "æœªåˆ†é¡" }} Â· {{ e.method || "ç¾é‡‘" }}</div>
                      <div class="mt-1 font-bold text-[16px] break-words">{{ e.title || "ï¼ˆæœªå¡«é …ç›®ï¼‰" }}</div>
                      <div class="mt-1 text-[13px] hint break-words" v-if="e.place">ğŸ“ {{ e.place }}</div>

                      <div class="mt-2 flex flex-wrap gap-2">
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          é‡‘é¡ï¼š{{ e.currency }} {{ money(e.amount) }}
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          ç´„ NT$ {{ money(e.amountTWD) }}
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          ç”± {{ personName(e.paidBy) }} æ”¯ä»˜
                        </span>
                        <span class="text-[12px] px-2 py-1 rounded-xl chip">
                          åˆ†æ”¤ {{ e.splitAmong.length }} äºº
                          <span v-if="hasCustomSplit(e)"> Â· å«è‡ªè¨‚</span>
                          <span v-else> Â· å¹³å‡ NT$ {{ money(e.amountTWD / Math.max(1,e.splitAmong.length)) }}</span>
                        </span>
                      </div>

                      <div class="mt-2 text-[13px] break-words" v-if="e.note">ğŸ“ {{ e.note }}</div>

                      <div class="mt-3" v-if="e.receipt">
                        <img :src="e.receipt" class="w-full max-h-56 object-cover rounded-2xl border"
                             style="border-color: var(--line);" />
                      </div>
                    </div>

                    <div class="flex flex-col gap-2 shrink-0">
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="editExpense(e)">
                        âœï¸
                      </button>
                      <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                              @click="removeExpense(e.id)">
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- settlement -->
              <div class="mt-5 rounded-3xl p-4 bg-white/70 border shadow-soft" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <!-- âœ… åˆªæ‰ã€Œèª°æ¬ èª°ã€ä¸‰å€‹å­— -->
                  <div class="font-bold text-[16px]">ğŸ§¾ çµé¤˜</div>
                  <div class="text-[12px] hint">ä¾æŠ˜å°å¹£è¨ˆç®—</div>
                </div>
                <div class="mt-3 grid gap-2">
                  <div v-for="(line,idx) in settlementLines()" :key="'st-'+idx"
                       class="rounded-2xl p-3 border bg-white/70"
                       style="border-color: var(--line);">
                    {{ line }}
                  </div>
                  <div v-if="settlementLines().length===0" class="text-center hint py-4">
                    ç›®å‰å‰›å¥½éƒ½æ‰“å¹³ âœ¨
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- è¡Œæ -->
        <section v-show="tab==='luggage'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-bold text-[16px]">ğŸ’ è¡Œææ¸…å–®</div>
                  <div class="text-[13px] hint mt-1">å¯æ–°å¢é …ç›®ï¼›åˆªé™¤æ”¹æˆç´…è‰²ã€Œï¼ã€</div>
                </div>
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="openAddLuggage()">
                  â• æ–°å¢
                </button>
              </div>
            </div>

            <div class="p-4 space-y-4">
              <div v-for="cat in luggageCategories()" :key="cat" class="rounded-3xl p-4 bg-white/70 border"
                   style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold">ğŸ“¦ {{ cat }}</div>
                  <div class="text-[12px] hint">
                    {{ luggageItems(cat).filter(i=>i.done).length }}/{{ luggageItems(cat).length }}
                  </div>
                </div>

                <div class="mt-3 space-y-2">
                  <div v-for="it in luggageItems(cat)" :key="it.id"
                       class="flex items-center gap-2 rounded-2xl p-2 border bg-white/70"
                       style="border-color: var(--line);">
                    <input type="checkbox" v-model="it.done" @change="persist()"
                           class="w-5 h-5 accent-blue-500" />
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold truncate">{{ it.name }}</div>
                      <div class="text-[12px] hint" v-if="it.note">ğŸ“ {{ it.note }}</div>
                    </div>
                    <button class="w-9 h-9 rounded-2xl grid place-items-center border bg-white/70 hover:bg-white"
                            style="border-color: var(--line); color: #ef4444;"
                            @click="removeLuggage(it.id)">
                      ï¼
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>

        <!-- æ”¶è— -->
        <section v-show="tab==='fav'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">â­ æ”¶è—</div>
                  <div class="text-[13px] hint mt-1">åˆ†é¡å¯æ–°å¢ï¼›ä»¥ã€Œåœ°å€ã€è‡ªå‹•åˆ†çµ„</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                          @click="openFavCategoryManager=true">
                    ğŸ·ï¸ é¡å‹
                  </button>
                  <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                          @click="openAddFav()">
                    â• æ–°å¢
                  </button>
                </div>
              </div>

              <div class="mt-3 flex gap-2 overflow-x-auto pb-2">
                <button class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="favFilter==='' ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="favFilter=''">
                  å…¨éƒ¨
                </button>
                <button v-for="c in activeTrip.favCategories" :key="'fc-'+c"
                        class="shrink-0 rounded-2xl px-3 py-2 text-[13px] border"
                        :class="favFilter===c ? 'segActive':'bg-white/70 hover:bg-white'"
                        style="border-color: var(--line);"
                        @click="favFilter=c">
                  {{ c }}
                </button>
              </div>
            </div>

            <div class="p-4">
              <div v-if="filteredFav().length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                é‚„æ²’æœ‰æ”¶è—ï½çœ‹åˆ°æƒ³å»çš„å°±å…ˆä¸Ÿé€²ä¾† âœ¨
              </div>

              <div class="space-y-4">
                <div v-for="group in favGroupedByArea()" :key="group.area"
                     class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                  <div class="flex items-center justify-between">
                    <div class="font-bold">ğŸ“ {{ group.area }}</div>
                    <div class="text-[12px] hint">{{ group.items.length }} ç­†</div>
                  </div>

                  <div class="mt-3 space-y-3">
                    <div v-for="it in group.items" :key="it.id"
                         class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                         style="border-color: var(--line);">
                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                          <div class="text-[12px] hint">ğŸ·ï¸ {{ it.category || "æœªåˆ†é¡" }} Â· ğŸ‘¤ {{ it.buyer || "â€”" }}</div>
                          <div class="mt-1 font-bold text-[16px] break-words">{{ it.name || "ï¼ˆæœªå¡«åç¨±ï¼‰" }}</div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <span class="text-[12px] px-2 py-1 rounded-xl chip">æ•¸é‡ï¼š{{ it.qty || 1 }}</span>
                            <span class="text-[12px] px-2 py-1 rounded-xl chip" v-if="it.price">
                              åƒ¹æ ¼ï¼š{{ it.currency || "KRW" }} {{ money(it.price) }}
                            </span>
                            <span class="text-[12px] px-2 py-1 rounded-xl chip" v-if="it.place">
                              åœ°é»ï¼š{{ it.place }}
                            </span>
                          </div>
                          <div class="mt-2 text-[13px] break-words" v-if="it.note">ğŸ“ {{ it.note }}</div>
                          <div class="mt-2" v-if="it.link">
                            <a :href="it.link" target="_blank" class="text-[12px] underline decoration-baby/60">ğŸ”— é€£çµ</a>
                          </div>
                          <div class="mt-3" v-if="it.image">
                            <img :src="it.image" class="w-full max-h-56 object-cover rounded-2xl border"
                                 style="border-color: var(--line);" />
                          </div>
                        </div>

                        <div class="flex flex-col gap-2 shrink-0">
                          <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                  @click="editFav(it)">
                            âœï¸
                          </button>
                          <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                  @click="removeFav(it.id)">
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- ä»£è³¼/è³¼ç‰© -->
        <section v-show="tab==='shop'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">ğŸ›ï¸ è³¼ç‰© / ä»£è³¼æ¸…å–®</div>
                  <div class="text-[13px] hint mt-1">å¯æ”¾å•†å“ã€æ•¸é‡ã€åƒ¹æ ¼ã€è³¼è²·äººã€å‚™è¨»</div>
                </div>
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="openAddShop()">
                  â• æ–°å¢
                </button>
              </div>
            </div>

            <div class="p-4 space-y-3">
              <div v-if="activeTrip.shop.length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                æ¸…å–®ç©ºç©ºï½å…ˆæŠŠæƒ³è²·çš„æ”¾é€²ä¾† âœ¨
              </div>

              <div v-for="it in activeTrip.shop" :key="it.id"
                   class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                   style="border-color: var(--line);">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-[12px] hint">ğŸ‘¤ {{ it.buyer || "â€”" }} Â· ğŸ“ {{ it.place || "â€”" }}</div>
                    <div class="mt-1 font-bold text-[16px] break-words">{{ it.name || "ï¼ˆæœªå¡«åç¨±ï¼‰" }}</div>
                    <div class="mt-2 flex flex-wrap gap-2">
                      <span class="text-[12px] px-2 py-1 rounded-xl chip">æ•¸é‡ï¼š{{ it.qty || 1 }}</span>
                      <span class="text-[12px] px-2 py-1 rounded-xl chip" v-if="it.price">
                        åƒ¹æ ¼ï¼š{{ it.currency || "KRW" }} {{ money(it.price) }}
                      </span>
                    </div>
                    <div class="mt-2 text-[13px] break-words" v-if="it.note">ğŸ“ {{ it.note }}</div>
                    <div class="mt-2" v-if="it.link">
                      <a :href="it.link" target="_blank" class="text-[12px] underline decoration-baby/60">ğŸ”— é€£çµ</a>
                    </div>
                    <div class="mt-3" v-if="it.image">
                      <img :src="it.image" class="w-full max-h-56 object-cover rounded-2xl border"
                           style="border-color: var(--line);" />
                    </div>
                  </div>

                  <div class="flex flex-col gap-2 shrink-0">
                    <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                            @click="editShop(it)">
                      âœï¸
                    </button>
                    <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                            @click="removeShop(it.id)">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- è³‡è¨Š -->
        <section v-show="tab==='info'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">ğŸ“Œ å›ºå®šè³‡è¨Š & å‚™å¿˜éŒ„</div>
                  <div class="text-[13px] hint mt-1">å›ºå®šè³‡è¨Šå…ˆé å¡«ï¼›åº•ä¸‹å¯è‡ªç”±æ–°å¢ä»»ä½•å‚™è¨»ï¼ˆæ¬„ä½éƒ½å¯ç©ºï¼‰</div>
                </div>
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="openAddNote()">
                  â• æ–°å¢å‚™å¿˜
                </button>
              </div>
            </div>

            <div class="p-4 space-y-4">
              <!-- Fixed info -->
              <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                <div class="font-bold text-[15px]">ğŸ¤ æ¼”å”±æœƒ</div>
                <div class="mt-2 text-[13px] space-y-1">
                  <div>ITZY 3RD WORLD TOUR ï¼œTUNNEL VISIONï¼ in SEOUL</div>
                  <div class="hint">Day1ï¼š2026/02/13 19:30 or 20:00 (KST)</div>
                  <div class="hint">Day2ï¼š2026/02/14 18:00 (KST)</div>
                  <div class="hint">Day3ï¼š2026/02/15 17:00 (KST)</div>
                </div>
              </div>

              <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                <div class="font-bold text-[15px]">ğŸ  ä½å®¿</div>
                <div class="mt-2 text-[13px] space-y-1">
                  <div class="hint">å…¥ä½ï¼š2026/02/11 â†’ 02/15ï¼ˆå››æ™šï¼‰</div>
                  <div class="hint">åœ°å€ï¼šì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 619-16ï¼ˆå‘¨åœ / å°šæœªæ˜ç¢ºé–€ç‰Œï¼‰</div>
                  <a class="text-[12px] underline decoration-baby/60" target="_blank"
                     href="https://www.airbnb.com.tw/rooms/1318488266686350601?adults=3&check_in=2026-02-11&check_out=2026-02-15&children=0&infants=0&pets=0&wishlist_item_id=11005531884430&source_impression_id=p3_1762490096_P3hggLZkdlP2Ymtq&previous_page_section_name=1000">
                    ğŸ”— Airbnb é€£çµ
                  </a>
                </div>
              </div>

              <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                <div class="font-bold text-[15px]">âœˆï¸ èˆªç­ï¼ˆè©³ç´°ï¼‰</div>
                <div class="mt-3 grid gap-3">
                  <div class="rounded-2xl p-3 border bg-white/70" style="border-color: var(--line);">
                    <div class="font-semibold">å»ç¨‹ï½œ2026/02/11ï¼ˆä¸‰ï¼‰</div>
                    <div class="text-[13px] hint mt-1">TPE æ¡ƒåœ’æ©Ÿå ´ T1 12:25ï¼ˆå°ç£æ™‚é–“ï¼‰</div>
                    <div class="text-[13px] hint">â†’ ICN ä»å·æ©Ÿå ´ T2 15:50ï¼ˆéŸ“åœ‹æ™‚é–“ï¼‰</div>
                    <div class="text-[12px] hint mt-2">å»ºè­°ï¼šå‡ºç™¼å‰ 2.5â€“3 å°æ™‚åˆ°æ©Ÿå ´ï¼ˆçœ‹ä½ è¡Œæ/å ±åˆ°ç‹€æ³ï¼‰</div>
                  </div>
                  <div class="rounded-2xl p-3 border bg-white/70" style="border-color: var(--line);">
                    <div class="font-semibold">å›ç¨‹ï½œ2026/02/16ï¼ˆä¸€ï¼‰</div>
                    <div class="text-[13px] hint mt-1">ICN ä»å·æ©Ÿå ´ T2 09:00ï¼ˆéŸ“åœ‹æ™‚é–“ï¼‰</div>
                    <div class="text-[13px] hint">â†’ TPE æ¡ƒåœ’æ©Ÿå ´ T1 11:00ï¼ˆå°ç£æ™‚é–“ï¼‰</div>
                    <div class="text-[12px] hint mt-2">æé†’ï¼šé€™ç­å¾ˆæ—©ï¼Œå‰ä¸€æ™šè¡Œæå…ˆæ”¶å¥½æ¯”è¼ƒèˆ’æœ ğŸ˜´</div>
                  </div>
                </div>
              </div>

              <!-- Notes -->
              <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-[15px]">ğŸ“ è‡ªç”±å‚™å¿˜éŒ„</div>
                  <div class="text-[12px] hint">{{ activeTrip.notes.length }} ç­†</div>
                </div>

                <div class="mt-3 space-y-3">
                  <div v-if="activeTrip.notes.length===0" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                       style="border-color: var(--line);">
                    å…ˆæŠŠçœ‹åˆ°çš„è³‡è¨Šä¸Ÿé€²ä¾†ï½åƒæ˜¯ã€Œæƒ³é€›çš„åº— / çªç„¶æƒ³åˆ°çš„æé†’ã€âœ¨
                  </div>

                  <div v-for="n in activeTrip.notes" :key="n.id"
                       class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                       style="border-color: var(--line);">
                    <div class="flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-[12px] hint mono">
                          ğŸ“… {{ n.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰" }} Â· ğŸ•’ {{ n.time || "ï¼ˆæœªå¡«æ™‚é–“ï¼‰" }}
                        </div>
                        <div class="mt-1 font-bold text-[16px] break-words">{{ n.title || "ï¼ˆæœªå¡«æ¨™é¡Œï¼‰" }}</div>
                        <div class="mt-1 text-[13px] hint break-words" v-if="n.place">ğŸ“ {{ n.place }}</div>
                        <div class="mt-2 text-[13px] break-words" v-if="n.note">ğŸ“ {{ n.note }}</div>

                        <div class="mt-2 flex flex-wrap gap-2" v-if="n.link || n.map">
                          <a v-if="n.link" :href="n.link" target="_blank"
                             class="text-[12px] underline decoration-baby/60">ğŸ”— ç¶²å€</a>
                          <a v-if="n.map" :href="n.map" target="_blank"
                             class="text-[12px] underline decoration-lavender/60">ğŸ—ºï¸ åœ°åœ–</a>
                        </div>

                        <div class="mt-3 grid grid-cols-3 gap-2" v-if="(n.images||[]).length">
                          <img v-for="(img,idx) in n.images" :key="idx" :src="img"
                               class="w-full aspect-square object-cover rounded-2xl border"
                               style="border-color: var(--line);" />
                        </div>
                      </div>

                      <div class="flex flex-col gap-2 shrink-0">
                        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                @click="editNote(n)">
                          âœï¸
                        </button>
                        <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                                @click="removeNote(n.id)">
                          ğŸ—‘ï¸
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </section>

        <!-- å¤©æ°£ -->
        <section v-show="tab==='weather'">
          <div class="rounded-3xl bg-card shadow-soft border" style="border-color: var(--line);">
            <div class="p-4 border-b" style="border-color: var(--line);">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-bold text-[16px]">â˜ï¸ å¤©æ°£</div>
                  <div class="text-[13px] hint mt-1">é è¨­ Seoulï¼›ä¹Ÿå¯æ‰‹å‹•åˆ‡æ›åŸå¸‚</div>
                </div>
                <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white"
                        @click="refreshWeather()">
                  ğŸ”„ æ›´æ–°
                </button>
              </div>

              <div class="mt-3 flex gap-2">
                <input class="input rounded-2xl px-3 py-2 w-full text-[13px]"
                       placeholder="è¼¸å…¥åŸå¸‚ï¼ˆä¾‹ï¼šSeoul / Tokyo / Osakaï¼‰"
                       v-model="weatherQuery"
                       @keydown.enter="searchCity()" />
                <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                        @click="searchCity()">
                  ğŸ”
                </button>
              </div>

              <div class="mt-2 text-[12px] hint" v-if="weatherStatus">{{ weatherStatus }}</div>
            </div>

            <div class="p-4">
              <div v-if="weather.current" class="rounded-3xl p-4 bg-white/70 border shadow-soft"
                   style="border-color: var(--line);">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-bold text-[16px]">ğŸ“ {{ weather.cityName }}</div>
                    <div class="text-[13px] hint mt-1">æ›´æ–°ï¼š{{ weather.updatedAt }}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-[40px] font-extrabold mono">{{ weather.current.temperature }}Â°</div>
                    <div class="text-[12px] hint">é¢¨ {{ weather.current.windspeed }} km/h</div>
                  </div>
                </div>
              </div>

              <div v-if="weather.daily?.length" class="mt-4 space-y-2">
                <div v-for="d in weather.daily" :key="d.date"
                     class="rounded-2xl p-3 border bg-white/70 flex items-center justify-between"
                     style="border-color: var(--line);">
                  <div>
                    <div class="font-semibold">{{ d.date }}</div>
                    <div class="text-[12px] hint">{{ d.weekday }}</div>
                  </div>
                  <div class="mono font-bold">{{ d.tmax }}Â° / {{ d.tmin }}Â°</div>
                </div>
              </div>

              <div v-if="!weather.current" class="rounded-2xl p-4 border bg-white/65 text-center hint"
                   style="border-color: var(--line);">
                ç›®å‰é‚„æ²’æœ‰è³‡æ–™ï½æŒ‰ã€Œæ›´æ–°ã€æˆ–æœå°‹åŸå¸‚ âœ¨
              </div>
            </div>

          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav v-if="activeTrip" class="fixed bottom-0 left-0 right-0 z-50">
    <div class="max-w-[460px] mx-auto px-4 pb-[env(safe-area-inset-bottom)]">
      <div class="glass rounded-[28px] shadow-soft border p-2 mb-3"
           style="border-color: var(--line);">
        <div class="grid grid-cols-6 gap-1 text-[11px]">
          <button class="rounded-2xl py-2" @click="tab='plan'" :class="tab==='plan'?'segActive':''">ğŸ—“ï¸<div>è¡Œç¨‹</div></button>
          <button class="rounded-2xl py-2" @click="tab='money'" :class="tab==='money'?'segActive':''">ğŸ’¸<div>è¨˜å¸³</div></button>
          <button class="rounded-2xl py-2" @click="tab='luggage'" :class="tab==='luggage'?'segActive':''">ğŸ’<div>è¡Œæ</div></button>
          <button class="rounded-2xl py-2" @click="tab='fav'" :class="tab==='fav'?'segActive':''">â­<div>æ”¶è—</div></button>
          <button class="rounded-2xl py-2" @click="tab='shop'" :class="tab==='shop'?'segActive':''">ğŸ›ï¸<div>ä»£è³¼</div></button>
          <button class="rounded-2xl py-2" @click="tab='info'" :class="tab==='info'?'segActive':''">ğŸ“Œ<div>è³‡è¨Š</div></button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Modals -->
  <!-- Trip catalog modal -->
  <div v-if="openTripCatalog" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openTripCatalog=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">ğŸ“š è¡Œç¨‹ç›®éŒ„</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openTripCatalog=false">âœ–</button>
      </div>

      <div class="mt-3 space-y-3 max-h-[70vh] overflow-auto pr-1">
        <button class="w-full text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                style="border-color: var(--line);"
                @click="startCreateTrip()">
          <div class="font-bold">â• æ–°å¢è¡Œç¨‹</div>
          <div class="text-[13px] hint mt-1">å»ºç«‹æ–°çš„æ—…éŠè¨ˆç•«ï¼ˆå¯è¨­å®šé ­åƒ/æ—¥æœŸ/äººå“¡/èˆªç­ï¼‰</div>
        </button>

        <button v-for="t in store.trips" :key="'m-'+t.id"
                class="w-full text-left rounded-3xl p-4 bg-white/70 hover:bg-white border shadow-soft"
                style="border-color: var(--line);"
                @click="selectTrip(t.id); openTripCatalog=false">
          <div class="flex gap-3 items-center">
            <div class="w-12 h-12 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
              <img v-if="t.avatar" :src="t.avatar" class="w-full h-full object-cover" alt="">
              <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
            </div>
            <div class="min-w-0 flex-1">
              <div class="font-bold truncate">{{ t.title }}</div>
              <div class="text-[13px] hint mt-0.5">ğŸ“… {{ t.startDate }} â†’ {{ t.endDate }}</div>
            </div>
            <div class="text-[20px]">â€º</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Trip settings -->
  <div v-if="openTripSettings" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openTripSettings=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4
            max-h-[85vh] overflow-y-auto"
     style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">âš™ï¸ è¡Œç¨‹è¨­å®š</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openTripSettings=false">âœ–</button>
      </div>

      <div class="mt-4 space-y-3">
        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="font-semibold">ğŸ–¼ï¸ è¡Œç¨‹é ­åƒ</div>
          <div class="mt-2 flex items-center gap-3">
            <div class="w-16 h-16 rounded-3xl overflow-hidden border bg-white" style="border-color: var(--line);">
              <img v-if="activeTrip.avatar" :src="activeTrip.avatar" class="w-full h-full object-cover" alt="">
              <div v-else class="w-full h-full grid place-items-center">ğŸ§Š</div>
            </div>
            <div class="flex-1">
              <input type="file" accept="image/*" @change="onPickTripAvatar($event)" class="text-[13px]"/>
              <div class="text-[12px] hint mt-1">é¸å¥½æœƒè·³å‡ºè£åˆ‡ï¼Œå¯èª¿æ•´ä½ç½®</div>
            </div>
          </div>
        </div>

        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="font-semibold">ğŸ“ åç¨± / æ—¥æœŸ</div>
          <div class="mt-2 grid gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="activeTrip.title" placeholder="è¡Œç¨‹åç¨±ï¼ˆä¾‹å¦‚ï¼šé¦–çˆ¾ ITZY ä¸‰å·¡ï¼‰" @input="persist()">
            <div class="grid grid-cols-2 gap-2">
              <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="activeTrip.startDate" @change="syncDaysAfterTripEdit()">
              <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="activeTrip.endDate" @change="syncDaysAfterTripEdit()">
            </div>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="activeTrip.city" placeholder="é è¨­åŸå¸‚ï¼ˆSeoul / Tokyo ...ï¼‰" @input="persist()">
          </div>
        </div>

        <!-- âœ… èˆªç­ç®¡ç† -->
        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="flex items-center justify-between">
            <div class="font-semibold">âœˆï¸ èˆªç­</div>
            <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                    @click="startAddFlight()">
              â• æ–°å¢èˆªç­
            </button>
          </div>

          <div class="mt-3 grid gap-2">
            <div v-for="f in (activeTrip.flights||[])" :key="f.id"
                 class="rounded-2xl p-3 border bg-white/70 flex items-start justify-between gap-2"
                 style="border-color: var(--line);">
              <div class="min-w-0">
                <div class="font-semibold">{{ f.depAirport || "â€”" }} â†’ {{ f.arrAirport || "â€”" }}</div>
                <div class="text-[12px] hint mono">{{ f.type || "èˆªç­" }} Â· {{ f.date || "" }} Â· {{ f.depTime || "â€”" }} â†’ {{ f.arrTime || "â€”" }}</div>
                <div class="text-[12px] hint" v-if="f.flightNo">èˆªç­ï¼š{{ f.flightNo }}</div>
              </div>
              <div class="flex gap-2">
                <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                        @click="editFlight(f)">âœï¸</button>
                <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                        @click="removeFlight(f.id)">ğŸ—‘ï¸</button>
              </div>
            </div>

            <div v-if="(activeTrip.flights||[]).length===0" class="rounded-2xl p-3 border bg-white/65 text-center hint"
                 style="border-color: var(--line);">
              é‚„æ²’æ–°å¢èˆªç­ï½æŒ‰å³ä¸Šè§’ â• æ–°å¢ âœ¨
            </div>
          </div>
        </div>

        <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
          <div class="flex items-center justify-between">
            <div class="font-semibold">ğŸ‘¥ åƒèˆ‡äººå“¡</div>
            <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                    @click="startAddPerson()">
              â• æ–°å¢äººå“¡
            </button>
          </div>

          <div class="mt-3 grid gap-2">
            <div v-for="p in activeTrip.people" :key="p.id"
                 class="flex items-center gap-3 rounded-2xl p-2 border bg-white/70"
                 style="border-color: var(--line);">
              <div class="w-11 h-11 rounded-2xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="p.avatar" :src="p.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">{{ p.name }}</div>
              </div>
              <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                      @click="editPerson(p)">
                âœï¸
              </button>
              <button class="btn rounded-2xl px-3 py-2 text-[12px] bg-white/70 hover:bg-white"
                      @click="removePerson(p.id)">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                  @click="backToCatalog()">
            â†©ï¸ å›ç›®éŒ„
          </button>
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white"
                  style="color:#ef4444;"
                  @click="deleteTrip(activeTrip.id)">
            åˆªé™¤è¡Œç¨‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Currency Manager -->
  <div v-if="openCurrencyManager" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openCurrencyManager=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between gap-2">
        <div class="font-bold text-[16px]">ğŸ’± åŒ¯ç‡è¨­å®š</div>
        <div class="flex items-center gap-2">
          <!-- âœ… è‡ªå‹•æŠ“åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•æ”¹ï¼‰ -->
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                  @click="autoUpdateRates()">
            ğŸ”„ è‡ªå‹•æ›´æ–°
          </button>
          <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openCurrencyManager=false">âœ–</button>
        </div>
      </div>

      <div class="mt-3 text-[13px] hint">
        åŒ¯ç‡æ˜¯ã€Œ1 å–®ä½å¤–å¹£ = å¤šå°‘å°å¹£ã€ã€‚ä¾‹å¦‚ KRW 0.0212 è¡¨ç¤º â‚â‚€â‚€â‚€ KRW â‰ˆ 21.2 TWD
      </div>

      <div class="mt-4 space-y-2 max-h-[55vh] overflow-auto pr-1">
        <div v-for="c in activeTrip.currencies" :key="c.code"
             class="rounded-2xl p-3 border bg-white/70 flex items-center gap-2"
             style="border-color: var(--line);">
          <div class="font-bold w-14">{{ c.code }}</div>
          <input class="input rounded-2xl px-3 py-2 text-[13px] flex-1"
                 v-model="c.name" placeholder="åç¨±ï¼ˆé¸å¡«ï¼‰" @input="persist()">
          <input class="input rounded-2xl px-3 py-2 text-[13px] w-28 mono"
                 type="number" step="0.000001" v-model.number="c.rateToTWD" @input="persist()">
          <button v-if="c.code!=='TWD'" class="w-10 h-10 rounded-2xl border bg-white/70 hover:bg-white"
                  style="border-color: var(--line); color:#ef4444;"
                  @click="removeCurrency(c.code)">
            ï¼
          </button>
        </div>
      </div>

      <div class="mt-4 rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
        <div class="font-semibold">â• æ–°å¢å¹£åˆ¥</div>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="newCur.code" placeholder="ä»£ç¢¼(å¦‚ JPY)">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="newCur.name" placeholder="åç¨±(é¸å¡«)">
          <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.000001"
                 v-model.number="newCur.rateToTWD" placeholder="åŒ¯ç‡">
        </div>
        <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft mt-3"
                @click="addCurrency()">
          æ–°å¢
        </button>
      </div>
    </div>
  </div>

  <!-- Fav category manager -->
  <div v-if="openFavCategoryManager" class="fixed inset-0 z-[60] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="openFavCategoryManager=false"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">ğŸ·ï¸ æ”¶è—é¡å‹</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="openFavCategoryManager=false">âœ–</button>
      </div>

      <div class="mt-4 space-y-2">
        <div v-for="c in activeTrip.favCategories" :key="'cat-'+c"
             class="rounded-2xl p-3 border bg-white/70 flex items-center justify-between"
             style="border-color: var(--line);">
          <div class="font-semibold">{{ c }}</div>
          <button class="w-10 h-10 rounded-2xl border bg-white/70 hover:bg-white"
                  style="border-color: var(--line); color:#ef4444;"
                  @click="removeFavCategory(c)">
            ï¼
          </button>
        </div>
      </div>

      <div class="mt-4 rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
        <div class="font-semibold">â• æ–°å¢é¡å‹</div>
        <div class="mt-2 flex gap-2">
          <input class="input rounded-2xl px-3 py-2 text-[13px] flex-1" v-model="newFavCategory" placeholder="ä¾‹å¦‚ï¼šæ‹‰éºµ / å’–å•¡ / é€›è¡—">
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft"
                  @click="addFavCategory()">
            æ–°å¢
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic editor modal -->
  <div v-if="editor.open" class="fixed inset-0 z-[70] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/25" @click="closeEditor()"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">{{ editor.title }}</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="closeEditor()">âœ–</button>
      </div>

      <div class="mt-4 space-y-3 max-h-[70vh] overflow-auto pr-1">
        <!-- plan/note -->
        <template v-if="editor.type==='plan' || editor.type==='note'">
          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='note'">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.time" placeholder="æ™‚é–“ï¼ˆä¾‹ 11:30ï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='plan'">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.time" placeholder="æ™‚é–“ï¼ˆä¾‹ 11:30ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆä¾‹ åˆé¤ï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.title" placeholder="æ¨™é¡Œï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="åœ°é»ï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.map" placeholder="åœ°åœ–é€£çµï¼ˆå¯ç©ºï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.link" placeholder="ç¶²å€ï¼ˆå¯ç©ºï¼‰">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ–¼ï¸ åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" multiple @change="onAddImagesToEditor($event)">
            <div class="mt-3 grid grid-cols-3 gap-2" v-if="(editor.data.images||[]).length">
              <div v-for="(img,idx) in editor.data.images" :key="'ei-'+idx" class="relative">
                <img :src="img" class="w-full aspect-square object-cover rounded-2xl border" style="border-color: var(--line);">
                <button class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-white border shadow-soft grid place-items-center"
                        style="border-color: var(--line);"
                        @click="editor.data.images.splice(idx,1)">
                  âœ–
                </button>
              </div>
            </div>
          </div>
        </template>

        <!-- expense -->
        <template v-if="editor.type==='expense'">
          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆé¤é£²/äº¤é€šâ€¦ï¼‰">
          </div>
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.title" placeholder="é …ç›®ï¼ˆä¾‹ æ‹‰éºµï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="åœ°é»ï¼ˆå¯ç©ºï¼‰">

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.currency">
              <option v-for="c in activeTrip.currencies" :key="'cur-'+c.code" :value="c.code">{{ c.code }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.01" v-model.number="editor.data.amount" placeholder="é‡‘é¡">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.method">
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
            </select>
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.paidBy">
              <option v-for="p in activeTrip.people" :key="'pp-'+p.id" :value="p.id">{{ p.name }}</option>
            </select>
          </div>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ‘¥ åˆ†æ”¤äººå“¡</div>
            <div class="text-[12px] hint mt-1">âœ… å¯åœ¨å§“åå¾Œè¼¸å…¥ã€Œè‡ªè¨‚ NT$ã€ï¼›æ²’å¡«çš„äººæœƒå¹³åˆ†å‰©é¤˜é‡‘é¡</div>

            <div class="mt-3 grid gap-2">
              <div v-for="p in activeTrip.people" :key="'sp-'+p.id"
                   class="rounded-2xl p-2 border bg-white/70"
                   style="border-color: var(--line);">
                <div class="flex items-center gap-2">
                  <input type="checkbox" :value="p.id" v-model="editor.data.splitAmong"
                         class="w-5 h-5 accent-blue-500">
                  <span class="font-semibold flex-1">{{ p.name }}</span>

                  <!-- âœ… è‡ªè¨‚åˆ†æ”¤ -->
                  <input class="input rounded-2xl px-2 py-1 text-[12px] mono w-28"
                         type="number" step="1"
                         :disabled="!editor.data.splitAmong.includes(p.id)"
                         v-model.number="editor.data.splitCustom[p.id]"
                         placeholder="è‡ªè¨‚NT$" />
                </div>
              </div>
            </div>

            <div class="mt-3 rounded-2xl p-3 border bg-white/70" style="border-color: var(--line);">
              <div class="text-[13px] hint">
                é ä¼°åˆ†æ”¤ï¼š{{ previewSplitText(editor.data) }}
              </div>
            </div>
          </div>

          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ§¾ æ”¶æ“š/ç…§ç‰‡ï¼ˆå¯ç©ºï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" @change="onPickReceipt($event)">
            <div class="mt-3" v-if="editor.data.receipt">
              <img :src="editor.data.receipt" class="w-full max-h-56 object-cover rounded-2xl border" style="border-color: var(--line);">
            </div>
          </div>
        </template>

        <!-- âœ… flight -->
        <template v-if="editor.type==='flight'">
          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.type">
              <option>å»ç¨‹</option>
              <option>å›ç¨‹</option>
              <option>å…¶ä»–</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" type="date" v-model="editor.data.date">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.depAirport" placeholder="å‡ºç™¼æ©Ÿå ´ï¼ˆä¾‹ TPE T1ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.arrAirport" placeholder="æŠµé”æ©Ÿå ´ï¼ˆä¾‹ ICN T2ï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" v-model="editor.data.depTime" placeholder="å‡ºç™¼æ™‚é–“ï¼ˆä¾‹ 12:25ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" v-model="editor.data.arrTime" placeholder="æŠµé”æ™‚é–“ï¼ˆä¾‹ 15:50ï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.flightNo" placeholder="èˆªç­è™Ÿï¼ˆå¯ç©ºï¼‰">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>
        </template>

        <!-- fav / shop -->
        <template v-if="editor.type==='fav' || editor.type==='shop'">
          <div class="grid grid-cols-2 gap-2">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.area" placeholder="åœ°å€ï¼ˆä¾‹ æ±Ÿå— / å¼˜å¤§ï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.place" placeholder="è³¼ç‰©åœ°é»/åº—åï¼ˆå¯ç©ºï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='fav'">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category">
              <option value="">ï¼ˆæœªåˆ†é¡ï¼‰</option>
              <option v-for="c in activeTrip.favCategories" :key="'fop-'+c" :value="c">{{ c }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.buyer" placeholder="è³¼è²·äººï¼ˆå¯ç©ºï¼‰">
          </div>

          <div class="grid grid-cols-2 gap-2" v-if="editor.type==='shop'">
            <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.buyer" placeholder="è³¼è²·äººï¼ˆå¯ç©ºï¼‰">
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" v-model.number="editor.data.qty" placeholder="æ•¸é‡ï¼ˆé è¨­ 1ï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="å•†å“/åº—åï¼ˆå¯ç©ºï¼‰">

          <div class="grid grid-cols-2 gap-2">
            <select class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.currency">
              <option v-for="c in activeTrip.currencies" :key="'fc2-'+c.code" :value="c.code">{{ c.code }}</option>
            </select>
            <input class="input rounded-2xl px-3 py-2 text-[13px] mono" type="number" step="0.01"
                   v-model.number="editor.data.price" placeholder="åƒ¹æ ¼ï¼ˆå¯ç©ºï¼‰">
          </div>

          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.link" placeholder="ç¶²å€ï¼ˆå¯ç©ºï¼‰">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[90px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>

          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ–¼ï¸ åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰</div>
            <input class="mt-2 text-[13px]" type="file" accept="image/*" @change="onPickSingleImageToEditor($event)">
            <div class="mt-3" v-if="editor.data.image">
              <img :src="editor.data.image" class="w-full max-h-56 object-cover rounded-2xl border" style="border-color: var(--line);">
            </div>
          </div>
        </template>

        <!-- luggage add -->
        <template v-if="editor.type==='luggage'">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.category" placeholder="åˆ†é¡ï¼ˆä¾‹ å¿…éœ€å“/è—¥å“â€¦ï¼‰">
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="é …ç›®åç¨±">
          <textarea class="input rounded-2xl px-3 py-2 text-[13px] w-full min-h-[80px]"
                    v-model="editor.data.note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></textarea>
        </template>

        <!-- person -->
        <template v-if="editor.type==='person'">
          <div class="rounded-3xl p-4 bg-white/70 border" style="border-color: var(--line);">
            <div class="font-semibold">ğŸ™‚ äººå“¡é ­åƒ</div>
            <div class="mt-2 flex items-center gap-3">
              <div class="w-16 h-16 rounded-3xl overflow-hidden border bg-white" style="border-color: var(--line);">
                <img v-if="editor.data.avatar" :src="editor.data.avatar" class="w-full h-full object-cover" alt="">
                <div v-else class="w-full h-full grid place-items-center">ğŸ™‚</div>
              </div>
              <div class="flex-1">
                <input type="file" accept="image/*" @change="onPickPersonAvatar($event)" class="text-[13px]"/>
                <div class="text-[12px] hint mt-1">é¸å¥½æœƒè·³å‡ºè£åˆ‡ï¼Œç«‹å³çœ‹åˆ°æœ‰æ²’æœ‰é¸åˆ°ä½ è¦çš„ä½ç½®</div>
              </div>
            </div>
          </div>
          <input class="input rounded-2xl px-3 py-2 text-[13px]" v-model="editor.data.name" placeholder="åå­—ï¼ˆå¿…å¡«ï¼‰">
        </template>
      </div>

      <div class="mt-4 flex gap-2">
        <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                @click="closeEditor()">
          å–æ¶ˆ
        </button>
        <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft flex-1"
                @click="saveEditor()">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- Cropper modal -->
  <div v-if="crop.open" class="fixed inset-0 z-[80] grid place-items-center px-4">
    <div class="absolute inset-0 bg-black/35" @click="closeCropper(false)"></div>
    <div class="relative w-full max-w-[460px] rounded-[28px] bg-white shadow-soft border p-4"
         style="border-color: var(--line);">
      <div class="flex items-center justify-between">
        <div class="font-bold text-[16px]">âœ‚ï¸ è£åˆ‡ç…§ç‰‡</div>
        <button class="btn rounded-2xl px-3 py-2 text-[13px] bg-white/70 hover:bg-white" @click="closeCropper(false)">âœ–</button>
      </div>

      <div class="mt-4">
        <div class="text-[13px] hint">æ‹–æ›³ç§»å‹•ã€æ‹‰æ¡¿ç¸®æ”¾ï¼ˆæœƒå­˜æˆæ–¹å½¢é ­åƒï¼‰</div>

        <div class="mt-3 rounded-3xl border overflow-hidden bg-white shadow-soft"
             style="border-color: var(--line);">
          <div class="relative w-full aspect-square bg-slate-50 overflow-hidden"
               @pointerdown="cropPointerDown"
               @pointermove="cropPointerMove"
               @pointerup="cropPointerUp"
               @pointercancel="cropPointerUp">
            <img v-if="crop.imgSrc" :src="crop.imgSrc"
                 class="absolute left-1/2 top-1/2 select-none pointer-events-none"
                 :style="cropImgStyle()"
                 draggable="false" />
            <div class="absolute inset-0 ring-1 ring-white/40"></div>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <div class="text-[12px] hint w-10">ğŸ”</div>
          <input type="range" min="1" max="3" step="0.01" v-model.number="crop.scale" class="w-full">
          <div class="text-[12px] hint w-12 mono">{{ crop.scale.toFixed(2) }}x</div>
        </div>

        <div class="mt-4 flex gap-2">
          <button class="btn rounded-2xl px-4 py-2 text-[13px] bg-white/70 hover:bg-white flex-1"
                  @click="closeCropper(false)">
            å–æ¶ˆ
          </button>
          <button class="btnPrimary rounded-2xl px-4 py-2 text-[13px] font-semibold shadow-soft flex-1"
                  @click="closeCropper(true)">
            ä½¿ç”¨æ­¤è£åˆ‡
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const { createApp } = Vue;

createApp({
  data(){
    return {
      tab: "plan",
      nowText: "",
      store: this.loadStore(),

      openTripCatalog: false,
      openTripSettings: false,
      openCurrencyManager: false,
      openFavCategoryManager: false,

      activeTripId: "",
      activeDay: "",
      selectedExpenseDay: "",
      favFilter: "",

      editor: { open:false, type:"", title:"", data:{}, mode:"new", refId:"" },

      // currencies add
      newCur: { code:"", name:"", rateToTWD: 1 },

      // fav category add
      newFavCategory: "",

      // weather
      weatherQuery: "",
      weatherStatus: "",
      weather: { cityName:"", updatedAt:"", current:null, daily:[] },

      // cropper
      crop: {
        open:false,
        imgSrc:"",
        scale: 1.4,
        offX: 0,
        offY: 0,
        dragging:false,
        px:0, py:0,
        callback: null
      }
    }
  },
  computed:{
    activeTrip(){
      return this.store.trips.find(t=>t.id===this.activeTripId) || null;
    }
  },
  mounted(){
    this.tickNow();
    setInterval(this.tickNow, 1000*30);

    const last = localStorage.getItem("tripbook_activeTripId_v2");
    if (last && this.store.trips.some(t=>t.id===last)) {
      this.activeTripId = last;
      this.afterTripSelected();
    }
  },
  methods:{
    // ---------- store ----------
    loadStore(){
      const raw = localStorage.getItem("tripbook_store_v2");
      if(raw){
        try{ return JSON.parse(raw); }catch(e){}
      }
      return { trips: [] };
    },
    persist(){
      localStorage.setItem("tripbook_store_v2", JSON.stringify(this.store));
      if(this.activeTripId) localStorage.setItem("tripbook_activeTripId_v2", this.activeTripId);
    },
    uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); },

    // ---------- time ----------
    tickNow(){
      const d = dayjs();
      this.nowText = d.format("YYYY/MM/DD HH:mm");
    },
    daysUntil(dateStr){
      const a = dayjs().startOf('day');
      const b = dayjs(dateStr).startOf('day');
      return b.diff(a,'day');
    },
    md(dateStr){ return dayjs(dateStr).format("M/D"); },
    dow(dateStr){
      const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      return "é€±" + map[dayjs(dateStr).day()];
    },

    // ---------- trip days ----------
    tripDays(trip){
      const out=[];
      let d = dayjs(trip.startDate);
      const end = dayjs(trip.endDate);
      while(d.isBefore(end) || d.isSame(end,'day')){
        out.push(d.format("YYYY-MM-DD"));
        d = d.add(1,'day');
      }
      return out;
    },
    ensureTripShape(t){
      t.people ||= [];
      t.itinerary ||= {};
      t.expenses ||= [];
      t.notes ||= [];
      t.favCategories ||= ["åƒé£¯","å’–å•¡","é€›è¡—","æ™¯é»","è²·è²·","ä»£è³¼"];
      t.fav ||= [];
      t.shop ||= [];
      t.luggage ||= [];
      t.flights ||= [];
      t.currencies ||= [
        { code:"TWD", name:"å°å¹£", rateToTWD: 1 },
        { code:"KRW", name:"éŸ“å…ƒ", rateToTWD: 0.0212 },
        { code:"JPY", name:"æ—¥åœ“", rateToTWD: 0.22 }
      ];
      t.city ||= "Seoul";
      for(const d of this.tripDays(t)){
        if(!t.itinerary[d]) t.itinerary[d]=[];
      }
      if(!this.activeDay) this.activeDay = this.tripDays(t)[0] || "";
    },

    selectTrip(id){
      this.activeTripId = id;
      this.afterTripSelected();
      this.tab = "plan";
      this.persist();
    },
    afterTripSelected(){
      if(!this.activeTrip) return;
      this.ensureTripShape(this.activeTrip);
      const days = this.tripDays(this.activeTrip);
      this.activeDay = days.includes(this.activeDay) ? this.activeDay : (days[0]||"");
      this.selectedExpenseDay = "";
      this.favFilter = "";
      this.$nextTick(()=> this.mountSortable());
      this.weatherQuery = this.activeTrip.city || "Seoul";
      this.refreshWeather();
    },
    backToCatalog(){
      this.activeTripId = "";
      this.tab = "plan";
      this.openTripSettings=false;
      this.persist();
    },
    deleteTrip(id){
      if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) return;
      this.store.trips = this.store.trips.filter(t=>t.id!==id);
      this.activeTripId = "";
      this.persist();
      this.openTripSettings=false;
    },

    startCreateTrip(){
      const t = {
        id: this.uid(),
        title: "é¦–çˆ¾ ITZY ä¸‰å·¡",
        avatar: "",
        startDate: "2026-02-11",
        endDate: "2026-02-16",
        city: "Seoul",
        people: [
          { id: this.uid(), name: "æˆ‘", avatar: "" }
        ],
        flights: [
          { id:this.uid(), type:"å»ç¨‹", date:"2026-02-11", depAirport:"TPE T1", arrAirport:"ICN T2", depTime:"12:25", arrTime:"15:50", flightNo:"", note:"" },
          { id:this.uid(), type:"å›ç¨‹", date:"2026-02-16", depAirport:"ICN T2", arrAirport:"TPE T1", depTime:"09:00", arrTime:"11:00", flightNo:"", note:"å‰ä¸€æ™šè¡Œæå…ˆæ”¶å¥½æ¯”è¼ƒèˆ’æœ ğŸ˜´" }
        ],
        currencies: [
          { code:"TWD", name:"å°å¹£", rateToTWD: 1 },
          { code:"KRW", name:"éŸ“å…ƒ", rateToTWD: 0.0212 },
          { code:"JPY", name:"æ—¥åœ“", rateToTWD: 0.22 }
        ],
        itinerary: {},
        expenses: [],
        notes: [],
        favCategories: ["åƒé£¯","å’–å•¡","é€›è¡—","æ™¯é»","è²·è²·","ä»£è³¼"],
        fav: [],
        shop: [],
        luggage: this.seedLuggage()
      };
      this.store.trips.unshift(t);
      this.ensureTripShape(t);
      this.activeTripId = t.id;
      this.openTripCatalog=false;
      this.persist();
      this.afterTripSelected();
      this.openTripSettings=true;
    },

    // ---------- UI helpers ----------
    segClass(key){ return (this.tab===key) ? "segActive" : "bg-white/70 hover:bg-white"; },
    money(n){
      const x = Number(n||0);
      return x.toLocaleString("zh-Hant", { maximumFractionDigits: 0 });
    },

    // ---------- luggage ----------
    seedLuggage(){
      const add = (cat, name, note="") => ({ id:this.uid(), category:cat, name, note, done:false });
      const arr = [];
      ["éŒ¢åŒ…","é‘°åŒ™","è­·ç…§","èº«åˆ†è­‰å½±æœ¬","é£¯åº—è¨‚è³¼è³‡è¨Šå½±æœ¬","è€³æ©Ÿ","S24U/éš¨èº«ç¢Ÿ/ç¡¬ç¢Ÿ","å¹³æ¿","è¡›ç”Ÿç´™","å¡‘è† è¢‹","å‚˜","è¬ç”¨æ’é ­/å……é›»ç·š","è¡Œå‹•é›»æº(è¨˜å¾—WHæ¨™ç¤º)","è¡›ç”Ÿæ£‰","çœ¼é¡/ç›’å­/éš±å½¢æ—¥æ‹‹","é€æ˜å¤¾éˆè¢‹","æ‰‹æ©Ÿæ›ç¹©","é…’ç²¾æ¿•ç´™å·¾","è¡Œæè¢‹"]
        .forEach(x=>arr.push(add("å¿…éœ€å“", x)));
      ["OKè¹¦","é˜²æ›¬","å£ç½©","éæ•è—¥"].forEach(x=>arr.push(add("è—¥å“", x)));
      ["ç‰™è†ç‰™åˆ·","æ´—é¢ä¹³","å¸å¦","ä¹³æ¶²","é›¢å­å¤¾","æ¢³å­","é«®å¤¾é«®åœˆé«®å¸¶","æµ´å·¾(æ‹‹æ£„å¼)","åŒ–å¦åŒ…"]
        .forEach(x=>arr.push(add("æ´—æ¼±ç”¨å“", x)));
      ["è¡£æœ","è¤²å­","ç¡è¡£","å¤–å¥—","è¥ªå­","å…§è¡£å…§è¤²","é£¾å“"].forEach(x=>arr.push(add("è¡£ç‰©", x)));
      ["æ‰‹ç‡ˆ/è²“è€³/è£é£¾/é›»æ± ","å¨ƒå¨ƒ","å¡/å¡å¥—/å¡ç›’/å¡è†œ","æœƒå“¡å¡"].forEach(x=>arr.push(add("è¿½æ˜Ÿ", x)));
      return arr;
    },
    luggageCategories(){
      const set = new Set((this.activeTrip?.luggage||[]).map(i=>i.category||"æœªåˆ†é¡"));
      return Array.from(set);
    },
    luggageItems(cat){
      return (this.activeTrip.luggage||[]).filter(i=>(i.category||"æœªåˆ†é¡")===cat);
    },
    openAddLuggage(){
      this.editor = { open:true, type:"luggage", title:"â• æ–°å¢è¡Œæ", mode:"new", refId:"", data:{ category:"å¿…éœ€å“", name:"", note:"" } };
    },
    removeLuggage(id){
      this.activeTrip.luggage = this.activeTrip.luggage.filter(i=>i.id!==id);
      this.persist();
    },

    // ---------- plan ----------
    mountSortable(){
      if(!this.activeTrip || !this.activeDay) return;
      const el = document.getElementById("planList-"+this.activeDay);
      if(!el) return;

      // é‡æ–° mountï¼ˆé¿å…åˆ‡æ—¥å¾Œä¸èƒ½æ‹–ï¼‰
      if(el.__sortableInstance){
        el.__sortableInstance.destroy();
        el.__sortableInstance = null;
      }

      el.__sortableInstance = Sortable.create(el, {
        animation: 180,
        delay: 200,
        delayOnTouchOnly: true,
        ghostClass: "opacity-60",
        onEnd: (evt)=>{
          const list = this.activeTrip.itinerary[this.activeDay] || [];
          const moved = list.splice(evt.oldIndex, 1)[0];
          list.splice(evt.newIndex, 0, moved);
          this.persist();
        }
      });
    },
    syncDaysAfterTripEdit(){
      if(!this.activeTrip) return;
      const keep = this.activeTrip.itinerary || {};
      const next = {};
      for(const d of this.tripDays(this.activeTrip)){
        next[d] = keep[d] || [];
      }
      this.activeTrip.itinerary = next;
      this.activeDay = this.tripDays(this.activeTrip)[0] || "";
      this.persist();
      this.$nextTick(()=> this.mountSortable());
    },
    openAddPlanItem(){
      this.editor = {
        open:true, type:"plan", title:"â• æ–°å¢è¡Œç¨‹", mode:"new", refId:"",
        data:{ id:this.uid(), time:"", category:"", title:"", place:"", map:"", link:"", note:"", images:[] }
      };
    },
    editPlanItem(item){
      this.editor = {
        open:true, type:"plan", title:"âœï¸ ç·¨è¼¯è¡Œç¨‹", mode:"edit", refId:item.id,
        data: JSON.parse(JSON.stringify(item))
      };
    },
    removePlanItem(id){
      if(!confirm("åˆªé™¤æ­¤è¡Œç¨‹é …ç›®ï¼Ÿ")) return;
      this.activeTrip.itinerary[this.activeDay] = (this.activeTrip.itinerary[this.activeDay]||[]).filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- notes ----------
    openAddNote(){
      this.editor = {
        open:true, type:"note", title:"â• æ–°å¢å‚™å¿˜", mode:"new", refId:"",
        data:{ id:this.uid(), date:"", time:"", title:"", place:"", map:"", link:"", note:"", images:[] }
      };
    },
    editNote(n){
      this.editor = {
        open:true, type:"note", title:"âœï¸ ç·¨è¼¯å‚™å¿˜", mode:"edit", refId:n.id,
        data: JSON.parse(JSON.stringify(n))
      };
    },
    removeNote(id){
      if(!confirm("åˆªé™¤æ­¤å‚™å¿˜ï¼Ÿ")) return;
      this.activeTrip.notes = this.activeTrip.notes.filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- expenses ----------
    totalExpenseTWD(){
      return (this.activeTrip.expenses||[]).reduce((s,e)=>s+(Number(e.amountTWD)||0),0);
    },
    dayTotalTWD(d){
      if(!d) return this.totalExpenseTWD();
      return (this.activeTrip.expenses||[]).filter(e=>e.date===d).reduce((s,e)=>s+(Number(e.amountTWD)||0),0);
    },
    filteredExpenses(){
      const list = (this.activeTrip.expenses||[]).slice().sort((a,b)=>(a.date>b.date?-1:1));
      if(!this.selectedExpenseDay) return list;
      return list.filter(e=>e.date===this.selectedExpenseDay);
    },
    calcExpenseTWD(e){
      const c = this.activeTrip.currencies.find(x=>x.code===e.currency) || { rateToTWD:1 };
      return Number(e.amount||0) * Number(c.rateToTWD||1);
    },

    hasCustomSplit(e){
      const sc = e.splitCustom || {};
      return Object.keys(sc).some(k => Number(sc[k]) > 0);
    },

    openAddExpense(){
      const defaultDate = this.activeDay || this.tripDays(this.activeTrip)[0] || dayjs().format("YYYY-MM-DD");
      this.editor = {
        open:true, type:"expense", title:"â• æ–°å¢è¨˜å¸³", mode:"new", refId:"",
        data:{
          id:this.uid(),
          date: defaultDate,
          category:"é¤é£²",
          title:"",
          place:"",
          currency:"KRW",
          amount: 0,
          amountTWD: 0,
          method:"ç¾é‡‘",
          paidBy: (this.activeTrip.people[0]?.id || ""),
          splitAmong: (this.activeTrip.people.map(p=>p.id)),
          splitCustom: {},   // âœ…
          note:"",
          receipt:""
        }
      };
    },
    editExpense(e){
      const copy = JSON.parse(JSON.stringify(e));
      copy.splitCustom ||= {}; // âœ…
      this.editor = {
        open:true, type:"expense", title:"âœï¸ ç·¨è¼¯è¨˜å¸³", mode:"edit", refId:e.id,
        data: copy
      };
    },
    removeExpense(id){
      if(!confirm("åˆªé™¤æ­¤ç­†è¨˜å¸³ï¼Ÿ")) return;
      this.activeTrip.expenses = this.activeTrip.expenses.filter(x=>x.id!==id);
      this.persist();
    },

    // âœ… ä¾ã€Œè‡ªè¨‚åˆ†æ”¤ã€è¨ˆç®—æ¯å€‹äººçš„å¯¦éš›åˆ†æ”¤ï¼ˆå°å¹£ï¼‰
    getExpenseShares(e){
      const amt = Number(e.amountTWD || 0);
      const people = new Set((this.activeTrip.people||[]).map(p=>p.id));
      const split = (e.splitAmong||[]).filter(pid=>people.has(pid));
      const custom = e.splitCustom || {};

      const chosen = split.length ? split : (e.paidBy ? [e.paidBy] : []);
      let customSum = 0;
      const filled = [];
      const blank = [];

      for(const pid of chosen){
        const v = Number(custom[pid]);
        if(v > 0){
          filled.push({pid, v});
          customSum += v;
        }else{
          blank.push(pid);
        }
      }

      const remain = Math.max(0, amt - customSum);
      const each = blank.length ? (remain / blank.length) : 0;

      const out = [];
      for(const f of filled) out.push({ pid: f.pid, shareTWD: f.v });
      for(const pid of blank) out.push({ pid, shareTWD: each });

      return out;
    },

    previewSplitText(e){
      e.amountTWD = this.calcExpenseTWD(e);
      const shares = this.getExpenseShares(e);
      if(!shares.length) return "â€”";
      const a = shares[0];
      const b = shares.length>1 ? shares[1] : null;
      const more = shares.length>2 ? `â€¦ï¼ˆå…± ${shares.length} äººï¼‰` : "";
      const one = `${this.personName(a.pid)} NT$ ${this.money(a.shareTWD)}`;
      const two = b ? `ã€${this.personName(b.pid)} NT$ ${this.money(b.shareTWD)}` : "";
      return one + two + (more ? " " + more : "");
    },

    // âœ… å€‹äººç´¯ç©ï¼ˆä¾åˆ†æ”¤ï¼‰
    personTotals(){
      const people = this.activeTrip.people || [];
      const totals = {};
      for(const p of people) totals[p.id] = 0;

      for(const e of (this.activeTrip.expenses||[])){
        const shares = this.getExpenseShares(e);
        for(const s of shares){
          if(totals[s.pid] !== undefined) totals[s.pid] += Number(s.shareTWD||0);
        }
      }

      return people.map(p=>({
        pid: p.id,
        name: p.name,
        avatar: p.avatar,
        total: Math.round(totals[p.id] || 0)
      })).sort((a,b)=>b.total-a.total);
    },

    // settlement
    personName(pid){
      return this.activeTrip.people.find(p=>p.id===pid)?.name || "ï¼ˆæœªçŸ¥ï¼‰";
    },
    settlementLines(){
      const people = this.activeTrip.people.map(p=>p.id);
      const balance = {};
      for(const pid of people) balance[pid]=0;

      for(const e of (this.activeTrip.expenses||[])){
        const amt = Number(e.amountTWD||0);
        const payer = e.paidBy;
        if(balance[payer]===undefined) balance[payer]=0;
        balance[payer] += amt;

        const shares = this.getExpenseShares(e);
        for(const s of shares){
          if(balance[s.pid]===undefined) balance[s.pid]=0;
          balance[s.pid] -= Number(s.shareTWD||0);
        }
      }

      const creditors = [];
      const debtors = [];
      for(const pid of people){
        const v = Math.round(balance[pid]);
        if(v>0) creditors.push({pid, v});
        else if(v<0) debtors.push({pid, v: -v});
      }
      creditors.sort((a,b)=>b.v-a.v);
      debtors.sort((a,b)=>b.v-a.v);

      const lines=[];
      let i=0,j=0;
      while(i<debtors.length && j<creditors.length){
        const d = debtors[i], c = creditors[j];
        const pay = Math.min(d.v, c.v);
        if(pay>0){
          // âœ… é€™è£¡æ”¹æˆæ›´ä¹¾æ·¨çš„ç®­é ­ï¼Œä¸ç”¨ã€Œèª°æ¬ èª°ã€å­—æ¨£
          lines.push(`${this.personName(d.pid)} â†’ ${this.personName(c.pid)}  NT$ ${this.money(pay)}`);
          d.v -= pay;
          c.v -= pay;
        }
        if(d.v===0) i++;
        if(c.v===0) j++;
      }
      return lines;
    },

    // ---------- currencies ----------
    addCurrency(){
      const code = (this.newCur.code||"").trim().toUpperCase();
      if(!code) return alert("è«‹è¼¸å…¥å¹£åˆ¥ä»£ç¢¼ï¼ˆä¾‹å¦‚ JPYï¼‰");
      if(this.activeTrip.currencies.some(c=>c.code===code)) return alert("å·²å­˜åœ¨æ­¤å¹£åˆ¥");
      const rate = Number(this.newCur.rateToTWD||0);
      if(!rate || rate<=0) return alert("è«‹è¼¸å…¥æ­£ç¢ºåŒ¯ç‡");
      this.activeTrip.currencies.push({ code, name:(this.newCur.name||""), rateToTWD: rate });
      this.newCur = { code:"", name:"", rateToTWD: 1 };
      this.persist();
    },
    removeCurrency(code){
      if(!confirm("åˆªé™¤å¹£åˆ¥ï¼Ÿ")) return;
      this.activeTrip.currencies = this.activeTrip.currencies.filter(c=>c.code!==code);
      this.persist();
    },

    // âœ… è‡ªå‹•æ›´æ–°åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•æ”¹ï¼‰
    async autoUpdateRates(){
      try{
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        const js = await res.json();
        const r = js.rates || {};
        if(!r.TWD) throw new Error("No TWD rate");
        const usdToTwd = Number(r.TWD);

        for(const c of this.activeTrip.currencies){
          if(c.code === "TWD"){ c.rateToTWD = 1; continue; }
          const usdToCur = Number(r[c.code]);
          if(!usdToCur) continue;
          const curToUsd = 1 / usdToCur;
          c.rateToTWD = Number((curToUsd * usdToTwd).toFixed(6));
        }
        this.persist();
        alert("å·²æ›´æ–°åŒ¯ç‡ï¼ˆä»å¯æ‰‹å‹•èª¿æ•´ï¼‰");
      }catch(e){
        alert("è‡ªå‹•æ›´æ–°åŒ¯ç‡å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ API æš«æ™‚ä¸å¯ç”¨ï¼‰ã€‚ä½ å¯ä»¥å…ˆæ‰‹å‹•è¼¸å…¥ã€‚");
      }
    },

    // ---------- fav ----------
    openAddFav(){
      this.editor = {
        open:true, type:"fav", title:"â• æ–°å¢æ”¶è—", mode:"new", refId:"",
        data:{ id:this.uid(), category:"", area:"æœªåˆ†é¡åœ°å€", name:"", price:null, currency:"KRW", qty:1, place:"", buyer:"", link:"", image:"", note:"" }
      };
    },
    editFav(it){
      this.editor = { open:true, type:"fav", title:"âœï¸ ç·¨è¼¯æ”¶è—", mode:"edit", refId:it.id, data: JSON.parse(JSON.stringify(it)) };
    },
    removeFav(id){
      if(!confirm("åˆªé™¤æ­¤æ”¶è—ï¼Ÿ")) return;
      this.activeTrip.fav = this.activeTrip.fav.filter(x=>x.id!==id);
      this.persist();
    },
    filteredFav(){
      const list = (this.activeTrip.fav||[]).slice();
      if(!this.favFilter) return list;
      return list.filter(x=>x.category===this.favFilter);
    },
    favGroupedByArea(){
      const list = this.filteredFav();
      const map = new Map();
      for(const it of list){
        const area = (it.area||"æœªåˆ†é¡åœ°å€").trim() || "æœªåˆ†é¡åœ°å€";
        if(!map.has(area)) map.set(area, []);
        map.get(area).push(it);
      }
      const groups = Array.from(map.entries()).map(([area,items])=>({
        area,
        items: items.sort((a,b)=>(a.category||"").localeCompare(b.category||""))
      }));
      groups.sort((a,b)=>{
        if(a.area==="æœªåˆ†é¡åœ°å€") return 1;
        if(b.area==="æœªåˆ†é¡åœ°å€") return -1;
        return a.area.localeCompare(b.area);
      });
      return groups;
    },
    addFavCategory(){
      const c = (this.newFavCategory||"").trim();
      if(!c) return;
      if(this.activeTrip.favCategories.includes(c)) return alert("å·²å­˜åœ¨æ­¤é¡å‹");
      this.activeTrip.favCategories.push(c);
      this.newFavCategory="";
      this.persist();
    },
    removeFavCategory(c){
      if(!confirm("åˆªé™¤æ­¤é¡å‹ï¼Ÿï¼ˆä¸æœƒåˆªé™¤å·²å­˜åœ¨çš„æ”¶è—é …ç›®ï¼Œåªæ˜¯ä¸å†å‡ºç¾åœ¨é¸å–®ï¼‰")) return;
      this.activeTrip.favCategories = this.activeTrip.favCategories.filter(x=>x!==c);
      if(this.favFilter===c) this.favFilter="";
      this.persist();
    },

    // ---------- shop ----------
    openAddShop(){
      this.editor = {
        open:true, type:"shop", title:"â• æ–°å¢ä»£è³¼/è³¼ç‰©", mode:"new", refId:"",
        data:{ id:this.uid(), area:"æœªåˆ†é¡åœ°å€", name:"", price:null, currency:"KRW", qty:1, place:"", buyer:"", link:"", image:"", note:"" }
      };
    },
    editShop(it){
      this.editor = { open:true, type:"shop", title:"âœï¸ ç·¨è¼¯ä»£è³¼/è³¼ç‰©", mode:"edit", refId:it.id, data: JSON.parse(JSON.stringify(it)) };
    },
    removeShop(id){
      if(!confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
      this.activeTrip.shop = this.activeTrip.shop.filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- flights ----------
    startAddFlight(){
      this.activeTrip.flights ||= [];
      this.editor = {
        open:true, type:"flight", title:"â• æ–°å¢èˆªç­", mode:"new", refId:"",
        data:{ id:this.uid(), type:"å»ç¨‹", date:"", depAirport:"", arrAirport:"", depTime:"", arrTime:"", flightNo:"", note:"" }
      };
    },
    editFlight(f){
      this.editor = { open:true, type:"flight", title:"âœï¸ ç·¨è¼¯èˆªç­", mode:"edit", refId:f.id, data: JSON.parse(JSON.stringify(f)) };
    },
    removeFlight(id){
      if(!confirm("åˆªé™¤æ­¤èˆªç­ï¼Ÿ")) return;
      this.activeTrip.flights = (this.activeTrip.flights||[]).filter(x=>x.id!==id);
      this.persist();
    },

    // ---------- editor save/close ----------
    closeEditor(){ this.editor.open=false; },
    saveEditor(){
      const t = this.editor.type;
      const data = this.editor.data;

      if(t==="person"){
        if(!data.name || !data.name.trim()) return alert("åå­—å¿…å¡«");
        if(this.editor.mode==="new"){
          this.activeTrip.people.push({ id:this.uid(), name:data.name.trim(), avatar: data.avatar||"" });
        }else{
          const p = this.activeTrip.people.find(x=>x.id===this.editor.refId);
          if(p){ p.name=data.name.trim(); p.avatar=data.avatar||""; }
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="flight"){
        this.activeTrip.flights ||= [];
        if(this.editor.mode==="new"){
          this.activeTrip.flights.unshift(data);
        }else{
          const idx = this.activeTrip.flights.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.flights[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="luggage"){
        if(!data.name || !data.name.trim()) return alert("é …ç›®åç¨±å¿…å¡«");
        this.activeTrip.luggage.push({ id:this.uid(), category:(data.category||"æœªåˆ†é¡"), name:data.name.trim(), note:data.note||"", done:false });
        this.persist(); this.closeEditor(); return;
      }

      if(t==="plan"){
        if(this.editor.mode==="new"){
          this.activeTrip.itinerary[this.activeDay].push(data);
        }else{
          const list = this.activeTrip.itinerary[this.activeDay]||[];
          const idx = list.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) list[idx]=data;
        }
        this.persist(); this.closeEditor();
        this.$nextTick(()=> this.mountSortable());
        return;
      }

      if(t==="note"){
        if(this.editor.mode==="new"){
          this.activeTrip.notes.unshift(data);
        }else{
          const idx = this.activeTrip.notes.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.notes[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="expense"){
        data.amountTWD = this.calcExpenseTWD(data);
        data.splitCustom ||= {};
        if(!data.date) return alert("è«‹å¡«æ—¥æœŸï¼ˆè¨˜å¸³éœ€è¦æ—¥æœŸï¼‰");
        if(!data.splitAmong || data.splitAmong.length===0) return alert("è‡³å°‘é¸ 1 ä½åˆ†æ”¤äººå“¡");
        if(this.editor.mode==="new"){
          this.activeTrip.expenses.unshift(data);
        }else{
          const idx = this.activeTrip.expenses.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.expenses[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="fav"){
        if(this.editor.mode==="new"){
          this.activeTrip.fav.unshift(data);
        }else{
          const idx = this.activeTrip.fav.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.fav[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }

      if(t==="shop"){
        if(this.editor.mode==="new"){
          this.activeTrip.shop.unshift(data);
        }else{
          const idx = this.activeTrip.shop.findIndex(x=>x.id===this.editor.refId);
          if(idx>=0) this.activeTrip.shop[idx]=data;
        }
        this.persist(); this.closeEditor(); return;
      }
    },

    // ---------- image pick ----------
    readFileAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    },
    async onAddImagesToEditor(ev){
      const files = Array.from(ev.target.files||[]);
      if(!files.length) return;
      this.editor.data.images ||= [];
      for(const f of files){
        const url = await this.readFileAsDataURL(f);
        this.editor.data.images.push(url);
      }
      ev.target.value="";
    },
    async onPickSingleImageToEditor(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      this.editor.data.image = await this.readFileAsDataURL(f);
      ev.target.value="";
    },
    async onPickReceipt(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      this.editor.data.receipt = await this.readFileAsDataURL(f);
      ev.target.value="";
    },

    // ---------- people ----------
    startAddPerson(){
      this.editor = { open:true, type:"person", title:"â• æ–°å¢äººå“¡", mode:"new", refId:"", data:{ name:"", avatar:"" } };
    },
    editPerson(p){
      this.editor = { open:true, type:"person", title:"âœï¸ ç·¨è¼¯äººå“¡", mode:"edit", refId:p.id, data: JSON.parse(JSON.stringify(p)) };
    },
    removePerson(id){
      if(!confirm("åˆªé™¤æ­¤äººå“¡ï¼Ÿï¼ˆå·²è¨˜å¸³è³‡æ–™ä»æœƒä¿ç•™æ”¯ä»˜è€… idï¼Œå»ºè­°å…ˆæ”¹è¨˜å¸³ï¼‰")) return;
      this.activeTrip.people = this.activeTrip.people.filter(p=>p.id!==id);
      this.persist();
    },

    // ---------- avatar crop ----------
    async onPickTripAvatar(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      const src = await this.readFileAsDataURL(f);
      this.openCropper(src, (cropped)=>{
        this.activeTrip.avatar = cropped;
        this.persist();
      });
      ev.target.value="";
    },
    async onPickPersonAvatar(ev){
      const f = (ev.target.files||[])[0];
      if(!f) return;
      const src = await this.readFileAsDataURL(f);
      this.openCropper(src, (cropped)=>{
        this.editor.data.avatar = cropped; // immediate preview
      });
      ev.target.value="";
    },
    openCropper(src, cb){
      this.crop.open = true;
      this.crop.imgSrc = src;
      this.crop.scale = 1.4;
      this.crop.offX = 0;
      this.crop.offY = 0;
      this.crop.dragging = false;
      this.crop.callback = cb;
    },
    cropImgStyle(){
      const s = this.crop.scale;
      return {
        transform: `translate(calc(-50% + ${this.crop.offX}px), calc(-50% + ${this.crop.offY}px)) scale(${s})`,
        transformOrigin: "center",
        width: "100%",
        height: "100%",
        objectFit: "cover"
      };
    },
    cropPointerDown(e){
      this.crop.dragging = true;
      this.crop.px = e.clientX;
      this.crop.py = e.clientY;
      e.target.setPointerCapture?.(e.pointerId);
    },
    cropPointerMove(e){
      if(!this.crop.dragging) return;
      const dx = e.clientX - this.crop.px;
      const dy = e.clientY - this.crop.py;
      this.crop.px = e.clientX;
      this.crop.py = e.clientY;
      this.crop.offX += dx;
      this.crop.offY += dy;
    },
    cropPointerUp(){ this.crop.dragging = false; },
    closeCropper(use){
      if(!use){
        this.crop.open=false;
        return;
      }
      const size = 512;
      const canvas = document.createElement("canvas");
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext("2d");

      const img = new Image();
      img.onload = ()=>{
        const iw = img.width, ih = img.height;
        const scaleCover = Math.max(size/iw, size/ih);
        const dw = iw*scaleCover, dh = ih*scaleCover;
        const dx0 = (size - dw)/2;
        const dy0 = (size - dh)/2;

        const s = this.crop.scale;
        const dx = this.crop.offX * (size / 460);
        const dy = this.crop.offY * (size / 460);

        ctx.save();
        ctx.translate(size/2 + dx, size/2 + dy);
        ctx.scale(s, s);
        ctx.translate(-size/2, -size/2);
        ctx.drawImage(img, dx0, dy0, dw, dh);
        ctx.restore();

        const out = canvas.toDataURL("image/jpeg", 0.92);
        this.crop.open=false;
        if(typeof this.crop.callback==="function") this.crop.callback(out);
      };
      img.src = this.crop.imgSrc;
    },

    // ---------- weather (Open-Meteo) ----------
    async searchCity(){
      const q = (this.weatherQuery||"").trim();
      if(!q) return;
      this.weatherStatus = "æœå°‹åŸå¸‚ä¸­â€¦";
      try{
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=zh&format=json`;
        const res = await fetch(url);
        const js = await res.json();
        if(!js.results || !js.results.length){
          this.weatherStatus = "æ‰¾ä¸åˆ°åŸå¸‚ï¼Œè©¦è©¦è‹±æ–‡æ‹¼éŸ³ï¼ˆSeoul / Tokyoï¼‰";
          return;
        }
        const r = js.results[0];
        this.weather.cityName = `${r.name}${r.country ? " Â· "+r.country : ""}`;
        await this.fetchWeather(r.latitude, r.longitude);
        this.weatherStatus = "";
        this.activeTrip.city = q;
        this.persist();
      }catch(e){
        this.weatherStatus = "å¤©æ°£æœå‹™æš«æ™‚å¤±æ•—ï¼ˆè«‹ç¨å¾Œå†è©¦ï¼‰";
      }
    },
    async refreshWeather(){
      const q = (this.activeTrip?.city || this.weatherQuery || "Seoul").trim();
      this.weatherQuery = q;
      await this.searchCity();
    },
    async fetchWeather(lat, lon){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,windspeed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
      const res = await fetch(url);
      const js = await res.json();
      this.weather.updatedAt = dayjs().format("YYYY/MM/DD HH:mm");
      this.weather.current = {
        temperature: Math.round(js.current.temperature_2m),
        windspeed: Math.round(js.current.windspeed_10m)
      };
      const days = js.daily.time.map((t,idx)=>({
        date: t,
        weekday: this.dow(t),
        tmax: Math.round(js.daily.temperature_2m_max[idx]),
        tmin: Math.round(js.daily.temperature_2m_min[idx])
      }));
      this.weather.daily = days;
    }
  }
}).mount("#app");
</script>
</body>
</html>

